<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostItch</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/6379/6379850.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- YouTube IFrame Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Base styles for a deep dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a; /* Very dark background */
            color: #e6edf3; /* Light text for contrast */
            transition: background-color 0.3s ease, color 0.3s ease, font-size 0.3s ease; /* Smooth transitions for theme/text size */
        }
        /* New class to prevent body scrolling when a fullscreen modal is active */
        body.modal-fullscreen-active {
            overflow: hidden;
        }

        .gradient-bg {
            background-color: #0a0a0a; /* Consistent very dark background */
        }
        /* Main content area and header background */
        .main-bg {
            background-color: rgba(15, 15, 15, 0.9); /* Slightly lighter than body, with transparency */
            backdrop-filter: blur(12px); /* Increased blur for more depth */
            border: 1px solid rgba(40, 40, 40, 0.6); /* Subtle, darker border */
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); /* More pronounced shadow */
        }
        /* Card specific styling for posts */
        .card-bg {
            background-color: #1c1c1c; /* Darker card background */
            border: 1px solid #3a3a3a; /* Darker, more defined border */
            border-radius: 24px; /* More rounded corners - Increased from 12px */
            transition: all 0.3s ease-in-out; /* Keep general transition */
            opacity: 0.98; /* Almost opaque */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Initial shadow */
        }
        /* Re-introduced subtle hover effect, removed active state animation */
        .card-bg:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            opacity: 1;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); /* Stronger shadow on hover */
            border-color: #00bcd4; /* Teal border on hover */
        }
        /* Removed card-bg:active to allow hover to persist when child elements are clicked */
        /* .card-bg:active {
            transform: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border-color: #3a3a3a;
        } */

        /* Specific styles for Game Promotion cards */
        .card-promo {
            border-color: #007bff; /* Blue border for promos */
        }
        .card-promo:hover {
            border-color: #007bff; /* Keep blue border on hover for promos */
        }
        /* Specific styles for Devlog cards */
        .card-devlog {
            border-color: #ffc107; /* Yellow/Amber border for devlogs */
        }
        .card-devlog:hover {
            border-color: #ffc107; /* Keep yellow/amber border on hover for devlogs */
        }

        /* Input field styling */
        .input-bg {
            background-color: #1a1a1a; /* Dark input background */
            border: 1px solid #3a3a3a; /* Dark input border */
            border-radius: 8px; /* Rounded inputs */
            transition: all 0.3s ease-in-out;
            color: #e6edf3; /* Text color in input */
        }
        .input-bg:focus-within, .input-bg:focus {
            border-color: #00bcd4; /* Vibrant teal focus */
            box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.5); /* Teal glow on focus */
            outline: none; /* Remove default outline */
        }
        /* Primary button styling */
        .btn-primary {
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Blue to teal gradient */
            border-radius: 8px; /* Rounded buttons */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Initial shadow */
            border: none;
            opacity: 0.95;
            font-weight: 600; /* Slightly bolder text */
        }
        .btn-primary:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            opacity: 1;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.6); /* Stronger blue shadow on hover */
        }
        /* Navigation item styling */
        .nav-item {
            transition: color 0.3s ease-in-out;
            padding: 8px 0; /* Add padding for better click area */
        }
        .nav-item.active {
            color: #00bcd4; /* Vibrant teal for active tab */
            position: relative;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -6px; /* Slightly lower underline */
            left: 0;
            width: 100%;
            height: 3px; /* Thicker underline */
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Matching gradient underline */
            border-radius: 2px; /* Rounded ends for underline */
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px; /* Wider scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; /* Darker track */
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #007bff, #00bcd4); /* Blue to teal gradient thumb */
            border-radius: 50px; /* Fully rounded thumb */
        }
        /* Loader animation */
        .loader {
            border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #00bcd4; /* Teal loader */
            border-radius: 50%;
            width: 60px; /* Larger loader */
            height: 60px;
            animation: spin 1s linear infinite;
        }
        /* Spinner for load more button */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal backdrop and positioning */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9); /* Very dark, almost opaque backdrop */
            backdrop-filter: blur(12px); /* More blur for depth */
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            transition: all 0.3s ease-in-out; /* Smooth transition for fullscreen */
            max-height: 95vh; /* Limit modal height to prevent it from overflowing viewport */
            overflow-y: auto; /* Allow content inside modal to scroll */
            -webkit-overflow-scrolling: touch; /* Improve scrolling on iOS */
        }
        /* Fullscreen styles for the modal */
        .modal.fullscreen {
            top: 0;
            left: 0;
            width: 100vw !important; /* Override specific width */
            height: 100vh !important; /* Override specific height */
            transform: none; /* Remove translate */
            border-radius: 0; /* Remove rounded corners */
            padding: 1rem; /* Adjust padding for fullscreen */
            max-width: none !important; /* Remove max-width in fullscreen */
            max-height: none !important; /* Remove max-height in fullscreen */
            overflow-y: auto; /* Ensure scrolling is still enabled in fullscreen */
        }
        .modal-backdrop.fullscreen {
            background-color: #0a0a0a; /* Solid background for fullscreen */
            backdrop-filter: none; /* Remove blur for fullscreen */
        }

        /* Custom Checkbox (general style) */
        .custom-checkbox input { display: none; }
        .custom-checkbox span {
            padding: 10px 15px; /* More padding */
            border-radius: 8px; /* More rounded */
            border: 1px solid #3a3a3a; /* Darker border */
            background-color: #1a1a1a; /* Darker background */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Vertically center content */
            justify-content: center;
            text-align: center;
            color: #b0b0b0; /* Lighter text color */
            font-weight: 500;
        }
        /* Specific style for genre/platform checkboxes to enforce height */
        .grid-checkbox-uniform .custom-checkbox span {
            min-height: 60px; /* Standardize height for two lines of text */
            line-height: 1.2; /* Ensure consistent line height */
        }
        .custom-checkbox input:checked + span {
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Blue to teal gradient */
            color: white;
            border-color: #00bcd4; /* Teal border */
            box-shadow: 0 2px 10px rgba(0, 188, 212, 0.5); /* Teal shadow */
        }
        /* Highlight for searched genres */
        .custom-checkbox span.genre-highlight {
            background-color: #333; /* Darker background for highlight */
            border-color: #00bcd4; /* Teal border for highlight */
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.5); /* Subtle teal glow */
            color: #e6edf3; /* Ensure text is readable */
        }
        /* Custom Select (for dropdowns) */
        .custom-select { position: relative; }
        .custom-select select {
            appearance: none; -webkit-appearance: none;
            padding-right: 2.5rem; /* Space for arrow */
        }
        .custom-select::after {
            content: '\f078'; /* Font Awesome chevron-down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            pointer-events: none;
            color: #8b949e;
        }

        /* Improved card styling for media thumbnails */
        .card-bg .thumbnail-container {
            width: 100%;
            height: 192px; /* h-48 */
            overflow: hidden;
            background-color: #101010; /* Very dark background for empty media */
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #2a2a2a; /* Separator for media */
            position: relative; /* For play button overlay */
            border-radius: 0px 0px 0 0; /* Rounded top corners for thumbnail */
        }

        /* Ensure image and iframe inside thumbnail container are NOT rounded themselves */
        /* Added !important to ensure override */
        .card-bg .thumbnail-container img,
        .card-bg .thumbnail-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0 !important; /* Explicitly remove rounding from the media element itself */
        }

        /* Play button overlay for YouTube thumbnails */
        .play-button-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(9, 148, 144, 0.8), rgba(40, 170, 219, 0.8)); /* Faded blue-teal */
            border-radius: 50%;
            width: 60px; /* Slightly larger but cleaner */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease; /* Keep transition for scale effect */
            box-shadow: 0 0 8px rgba(40, 170, 219, 0.3); /* Subtle blue glow */
            backdrop-filter: blur(2px); /* Optional glassy effect */
            z-index: 10; /* Ensure it's above the image */
        }

        .play-button-overlay:hover {
            transform: translate(-50%, -50%) scale(1.1); /* Only scale on hover, removed pulse */
        }

        /* Play icon style */
        .play-button-overlay i {
            color: white;
            font-size: 2rem; /* Slightly smaller than before for balance */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }

        /* New: Combo button on preview card thumbnail */
        .combo-video-btn {
            position: absolute;
            bottom: 8px; /* Changed from top: 8px */
            left: 8px; /* Adjusted from 5px for better spacing */
            z-index: 15; /* Higher than play-button-overlay */
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Same as btn-primary */
            border-radius: 4px; /* Changed from 8px to 4px for less rounding (rounded-sm) */
            padding: 6px 10px; /* Smaller padding for preview card */
            color: white;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .combo-video-btn:hover {
            transform: translateY(-2px); /* Subtle lift on hover */
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.6); /* Stronger shadow */
        }

        /* Z-index for dropdown to appear above other elements */
        #more-dropdown {
            z-index: 60; /* Ensure this is higher than other elements like sort-by select */
        }

        /* New styles for video modal */
        .video-modal-content {
            border: 2px solid #00bcd4; /* Greenish/blue border */
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.7); /* Matching glow */
        }

        /* Styles for the back and share buttons in the modal */
        .modal-action-btn {
            background-color: transparent; /* Keep background transparent */
            border: none; /* Remove border */
            border-radius: 9999px; /* Fully rounded */
            width: 40px; /* Fixed width */
            height: 40px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af; /* Default grey color (text-gray-400 equivalent) */
            font-size: 1.25rem; /* Icon size */
            transition: color 0.2s ease-in-out; /* Only transition color */
            box-shadow: none; /* Ensure no shadow */
        }

        .modal-action-btn:hover {
            background-color: transparent; /* Ensure background remains transparent */
            border-color: transparent; /* Ensure border remains transparent */
            color: #ffffff; /* White icon on hover */
            transform: none; /* Remove any scale effect */
            box-shadow: none; /* Ensure no shadow on hover */
        }

        /* Removed transform and box-shadow from :active states to allow hover effects to persist on click */
        .modal-action-btn:active {
            /* transform: none; */ /* Removed */
            /* box-shadow: none; */ /* Removed */
        }

        /* Also ensure the play button overlay doesn't have active animations */
        .play-button-overlay:active {
            transform: translate(-50%, -50%) scale(1) !important; /* Reset scale on active */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }
        /* Also ensure the combo video button doesn't have active animations */
        .combo-video-btn:active {
            /* transform: none !important; */ /* Removed */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }


        /* For the view/visit icons which are buttons but have cursor-default, ensure no active animation */
        .inline-flex .hover\:text-white:hover:active { /* Target the button within the span */
            /* transform: none !important; */ /* Removed */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }
		
        #ai-assistant-modal-content {
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 90vh;
            overflow-y: hidden; /* This allows vertical scrolling for the modal content */
        }

        #ai-assistant-modal-content .modal-header {
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        #ai-assistant-modal-content .iframe-container {
            flex-grow: 1;
            /* Keep this as hidden if the iframe itself handles its content scrolling. */
            /* If the iframe content is static and you want this container to scroll, change to overflow-y: auto; */
            overflow: hidden;
        }

        #ai-assistant-modal-content iframe {
            width: 100%;
            height: 100%; /* Make iframe fill its parent container */
            border: none;
            border-radius: 0.4rem; /* Tailwind rounded-lg */
        }

        /* New: No hover animation for disabled vote buttons */
        .vote-poll-btn[disabled]:hover {
            transform: none !important;
            transition: none !important;
            box-shadow: none !important;
        }

        /* New: Style for voted poll button */
        .vote-poll-btn.voted {
            background: #3a3a3a; /* A neutral dark background */
            color: #b0b0b0; /* Lighter text color */
            cursor: not-allowed;
            box-shadow: none; /* No shadow */
            opacity: 0.8; /* Slightly less opaque */
            transform: none; /* No transform on hover/active */
        }
        .vote-poll-btn.voted:hover {
            background: #3a3a3a; /* Keep the same background on hover */
            color: #b0b0b0; /* Keep the same text color on hover */
            box-shadow: none; /* No shadow on hover */
            transform: none; /* No transform on hover */
        }

        /* Theme-specific styles */
        body.light-mode {
            background-color: #fcfcfc; /* Very light, almost white */
            color: #212121; /* Darker text for better readability */
        }
        body.light-mode .main-bg {
            background-color: rgba(255, 255, 255, 0.98); /* Near white, slight transparency */
            border: 1px solid #e8e8e8; /* Very light border */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); /* Soft, subtle shadow */
        }
        body.light-mode .card-bg {
            background-color: #ffffff; /* Pure white cards */
            border: 1px solid #f5f5f5; /* Extremely light border */
            box-shadow: 0 1px 4px rgba(0,0,0,0.01); /* Very subtle shadow */
        }
        body.light-mode .card-bg:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            border-color: #00bcd4; /* Teal border on hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Slightly more pronounced shadow in light mode */
        }
        /* Removed card-bg:active for light mode as well */
        /* body.light-mode .card-bg:active {
            transform: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.01);
            border-color: #f5f5f5;
        } */
        body.light-mode .input-bg {
            background-color: #ffffff; /* White input background */
            border: 1px solid #e0e0e0; /* Light gray border */
            color: #212121; /* Dark text */
        }
        body.light-mode .input-bg:focus-within, body.light-mode .input-bg:focus {
            border-color: #00bcd4; /* Teal focus */
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1); /* Soft teal glow */
        }
        body.light-mode .text-gray-300 { color: #4a4a4a; } /* Darker gray for better readability */
        body.light-mode .text-gray-400 { color: #666666; }
        body.light-mode .text-gray-500 { color: #888888; }
        body.light-mode .text-white { color: #212121; } /* Header text in light mode */
        body.light-mode .bg-[#1a1a1a] { background-color: #f0f0f0; } /* For comments background, very light */
        body.light-mode .border-gray-700 { border-color: #e0e0e0; } /* Lighter border */
        body.light-mode .bg-gray-700 { background-color: #e8e8e8; color: #444444; } /* Tag background */
        body.light-mode .bg-purple-700 { background-color: #f0e6ff; color: #7a3ed6; } /* Purple tag */
        body.light-mode .bg-blue-700 { background-color: #e0f7fa; color: #007bff; } /* Blue tag */
        body.light-mode .bg-green-700 { background-color: #e6ffe6; color: #008000; } /* Green tag */
        body.light-mode .text-red-500 { color: #ef4444; } /* Ensure like button color is visible */
        body.light-mode .text-blue-500 { color: #3b82f6; } /* Ensure edit button color is visible */
        body.light-mode .modal-action-btn { color: #6b7280; } /* Darker icon color */
        body.light-mode .modal-action-btn:hover { color: #212121; } /* Darker icon on hover */
        
        /* New: Darker hover effect for like/comment/view/visit buttons in light mode */
        body.light-mode .like-btn:hover, 
        body.light-mode .comment-btn:hover,
        body.light-mode .inline-flex .hover\:text-white:hover { /* Target the button within the span */
            color: #007bff; /* A distinct blue for hover */
        }

        /* Light mode styling for unselected custom checkboxes */
        body.light-mode .custom-checkbox span {
            background-color: #f0f0f0; /* Light gray background */
            border-color: #d0d0d0; /* Slightly darker border */
            color: #4a4a4a; /* Darker text for readability */
        }
        body.light-mode .custom-checkbox input:checked + span {
            background: linear-gradient(90deg, #007bff, #00bcd4);
            color: white;
            border-color: #00bcd4;
            box-shadow: 0 2px 10px rgba(0, 188, 212, 0.5);
        }

        /* Text size classes */
        body.text-sm { font-size: 0.875rem; } /* 14px */
        body.text-base { font-size: 1rem; }    /* 16px (default) */
        body.text-lg { font-size: 1.125rem; }  /* 18px */

        /* Animations toggle */
        body.no-animations * {
            transition: none !important;
            animation: none !important;
        }

        /* Removed specific styles for video modal play button overlay */
        /* as it's no longer needed for the video modal itself */

        /* New: Remove transform animations on click for specific buttons */
        /* Removed !important overrides for transform and box-shadow to allow hover effects to persist on click */
        .like-btn:active,
        .comment-btn:active,
        .edit-btn:active,
        .delete-btn:active,
        .btn-primary:active {
            /* transform: none !important; */ /* Removed */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
            opacity: 1 !important; /* Ensure full opacity */
        }

        /* Also ensure the play button overlay doesn't have active animations */
        .play-button-overlay:active {
            transform: translate(-50%, -50%) scale(1) !important; /* Reset scale on active */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }
        /* Also ensure the combo video button doesn't have active animations */
        .combo-video-btn:active {
            /* transform: none !important; */ /* Removed */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }


        /* For the view/visit icons which are buttons but have cursor-default, ensure no active animation */
        .inline-flex .hover\:text-white:hover:active { /* Target the button within the span */
            /* transform: none !important; */ /* Removed */
            /* transition: none !important; */ /* Removed */
            /* box-shadow: none !important; */ /* Removed */
        }

	.formatting-toolbar-btn {
		background-color: transparent; /* Make background transparent for a minimalistic look */
		color: #e6edf3; /* Light text, will change on hover */
		padding: 0.6rem 0.85rem; /* Slightly more padding for a softer feel */
		border-radius: 0.5rem; /* More rounded, matches input-bg and btn-primary */
		transition: all 0.2s ease-in-out;
		box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Softer, more pronounced initial shadow */
		border: 1px solid #3a3a3a; /* Keep subtle border */
		display: flex; /* Use flex for perfect icon centering and flex-grow */
		align-items: center;
		justify-content: center;
		min-width: 40px; /* Ensure a consistent minimum width for all buttons */
		min-height: 40px; /* Ensure a consistent minimum height for all buttons */
		flex-grow: 1; /* NEW: Allows buttons to grow and fill available space evenly */
	}
	.formatting-toolbar-btn:hover {
		background-color: transparent; /* Keep background transparent for a clean look */
		color: #00bcd4; /* Icon changes to your app's signature teal */
		border-color: #00bcd4; /* Border changes to teal for a crisp highlight, matching app accent */
		transform: translateY(-0.5px); /* Very subtle upward lift for gentle interactivity */
		box-shadow: 0 1px 4px rgba(0, 188, 212, 0.2); /* Subtle teal-tinted shadow for depth, not an overpowering glow */
	}
	.formatting-toolbar-btn:active {
		background-color: #1a1a1a; /* Darker solid background for pressed state */
		border-color: #007bff; /* Blue border on active */
		transform: translateY(0); /* Reset lift */
		box-shadow: inset 0 2px 5px rgba(0,0,0,0.4); /* Deeper inset shadow for a "pressed" feel */
		color: #00bcd4; /* Keep teal color when pressed */
	}
        
        /* Style for the description preview area */
        #description-preview {
            background-color: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 12px;
            min-height: 100px; /* Ensure it has some height */
            max-height: 300px; /* Limit height */
            overflow-y: auto; /* Scroll if content overflows */
            color: #e6edf3;
            line-height: 1.6;
        }

        /* Markdown specific styling for preview and modal content */
        .markdown-content strong {
            font-weight: 700;
            color: inherit; /* Inherit text color */
        }
        .markdown-content em {
            font-style: italic;
            color: inherit; /* Inherit text color */
        }
        .markdown-content ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
            margin-top: 8px; /* Add some margin above the list */
            margin-bottom: 8px; /* Add some margin below the list */
        }
        .markdown-content ul li {
            margin-bottom: 0; /* Remove margin between list items */
            line-height: 1.5; /* Standard line height for readability */
        }
        .markdown-content code {
            background-color: #333;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: inherit; /* Inherit text color */
        }
        .markdown-content blockquote {
            border-left: 4px solid #007bff; /* Blue for blockquote */
            padding-left: 10px;
            margin-left: 0;
            color: inherit; /* Inherit text color */
            font-style: italic;
            margin-top: 8px; /* Add some margin above the blockquote */
            margin-bottom: 8px; /* Add some margin below the blockquote */
        }
        .markdown-content hr {
            border: none;
            border-top: 1px solid #555;
            margin: 1rem 0;
        }
        .markdown-content a {
            text-decoration: none; /* Remove underline by default */
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Gradient background */
            -webkit-background-clip: text; /* Clip background to text */
            background-clip: text; /* Clip background to text */
            color: transparent; /* Make text transparent to show background */
            transition: all 0.2s ease-in-out; /* Smooth transition for hover */
        }
        .markdown-content a:hover {
            background: linear-gradient(90deg, #00bcd4, #007bff); /* Reverse gradient on hover */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-decoration: underline; /* Add underline on hover */
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-7xl mx-auto px-4 py-4 sm:px-6">
        <header class="flex justify-between items-center py-4 px-4 main-bg rounded-lg shadow-lg">
            <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-wider">Post<span class="text-[#00bcd4]">Itch</span></h1>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="https://postitchindie.github.io/?section=community" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition active" data-tab="community">Community</a>
                <a href="https://postitchindie.github.io/?section=promos" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="promos">Game Promos</a>
                <a href="https://postitchindie.github.io/?section=devlogs" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="devlogs">Devlogs</a>
                <a href="https://postitchindie.github.io/?section=post" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="post">Post</a>
                <a href="https://postitchindie.github.io/?section=search" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="search">Search</a>
                <a href="https://postitchindie.github.io/?section=my-posts" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="my-posts">My Posts</a>
                <a href="https://postitchindie.github.io/?section=about" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="about">About</a>
                <a href="https://postitchindie.github.io/?section=rules" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="rules">Rules</a>
                <a href="https://postitchindie.github.io/?section=settings" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="settings">Settings</a> <!-- New Settings tab -->
            </nav>
            <div class="md:hidden">
                <button id="mobile-menu-btn"><i class="fas fa-bars text-2xl"></i></button>
            </div>
        </header>
        <div id="mobile-menu" class="hidden md:hidden main-bg rounded-lg mt-2 p-4">
             <a href="https://postitchindie.github.io/?section=community" class="block py-2 text-center nav-item" data-tab="community">Community</a>
             <a href="https://postitchindie.github.io/?section=promos" class="block py-2 text-center nav-item" data-tab="promos">Game Promos</a>
             <a href="https://postitchindie.github.io/?section=devlogs" class="block py-2 text-center nav-item" data-tab="devlogs">Devlogs</a>
             <a href="https://postitchindie.github.io/?section=post" class="block py-2 text-center nav-item" data-tab="post">Post</a>
             <a href="https://postitchindie.github.io/?section=search" class="block py-2 text-center nav-item" data-tab="search">Search</a>
             <a href="https://postitchindie.github.io/?section=my-posts" class="block py-2 text-center nav-item" data-tab="my-posts">My Posts</a>
             <a href="https://postitchindie.github.io/?section=about" class="block py-2 text-center nav-item" data-tab="about">About</a>
             <a href="https://postitchindie.github.io/?section=rules" class="block py-2 text-center nav-item" data-tab="rules">Rules</a>
             <a href="https://postitchindie.github.io/?section=settings" class="block py-2 text-center nav-item" data-tab="settings">Settings</a> <!-- New Settings tab -->
        </div>


        <main id="main-content" class="mt-8">
            <div id="loader" class="flex justify-center items-center h-64"><div class="loader"></div></div>
            <div id="content-community" class="tab-content"></div>
            <div id="content-promos" class="tab-content hidden"></div>
            <div id="content-devlogs" class="tab-content hidden"></div>
            <div id="content-post" class="tab-content hidden"></div>
            <div id="content-search" class="tab-content hidden"></div>
            <div id="content-my-posts" class="tab-content hidden"></div>
            <div id="content-about" class="tab-content hidden"></div>
            <div id="content-rules" class="tab-content hidden"></div>
            <div id="content-settings" class="tab-content hidden"></div> <!-- New Settings tab content -->
        </main>
    </div>
    
    <div id="post-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl h-5/6 main-bg rounded-lg shadow-lg p-4 sm:p-6"></div>
    </div>
    <div id="alert-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-sm main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="alert-message" class="mb-6"></p>
            <button id="alert-ok-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-md">OK</button>
        </div>
    </div>
    <div id="confirm-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-sm main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md">Yes</button>
                <button id="confirm-no-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md">No</button>
            </div>
        </div>
    </div>

	<!-- New Video Modal -->
	<div id="video-modal" class="hidden">
		<div class="modal-backdrop"></div>
		<div id="video-modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl main-bg rounded-lg shadow-lg p-4 sm:p-6 video-modal-content">
			<div class="flex justify-between mb-4">
                <button id="close-video-modal-btn" class="modal-action-btn"><i class="fa-solid fa-xmark"></i></button>
                <button id="fullscreen-video-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
			</div>
			<div class="aspect-video w-full rounded-md overflow-hidden relative" id="video-player-container">
				<!-- YouTube iframe will be dynamically inserted here -->
			</div>
		</div>
	</div>

<div id="ai-assistant-modal" class="hidden">
    <div class="modal-backdrop"></div>
    <div id="ai-assistant-modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl main-bg rounded-lg shadow-lg p-4 sm:p-6">
        <div class="modal-header flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">AI Assistant</h3>
            <button id="close-ai-assistant-modal-btn" class="modal-action-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
		<div class="iframe-container w-full h-full">
			<iframe class="w-full h-full rounded-lg" src="https://postitchguide.github.io/PostyAI/" title="AI Assistant"></iframe>
		</div>
					<div id="disclaimer-global" class="text-center text-gray-500 text-xs py-4 mt-8">
			<p><strong>Disclaimer:</strong> For the best experience, please view this modal on a desktop browser with your display zoom set to 100% and in fullscreen mode.</p>
		</div>
    </div>
</div>

    <!-- New Confirmation Input Modal -->
    <div id="confirm-input-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-md main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="confirm-input-message" class="mb-4 text-gray-300"></p>
            <p id="confirm-input-expected-text" class="mb-4 text-gray-200 font-semibold break-words"></p>
            <input type="text" id="confirm-input-field" class="w-full p-3 input-bg rounded-md mb-6 text-center" placeholder="Type here to confirm...">
            <div class="flex justify-center gap-4">
                <button id="confirm-input-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md" disabled>Confirm</button>
                <button id="confirm-input-no-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md">Cancel</button>
            </div>
        </div>
    </div>

    <!-- New Link Insertion Modal -->
    <div id="link-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-sm main-bg rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4 text-white">Insert Link</h3>
            <input type="url" id="link-url-input" class="w-full p-3 input-bg rounded-md mb-4" placeholder="Enter URL (e.g., https://example.com)" required>
            <input type="text" id="link-text-input" class="w-full p-3 input-bg rounded-md mb-6" placeholder="Enter display text (optional)">
            <div class="flex justify-end gap-4">
                <button id="cancel-link-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md">Cancel</button>
                <button id="insert-link-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-md">Insert</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, serverTimestamp, query, where, getDocs, limit, orderBy, startAfter, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - DIRECTLY INCLUDED AS REQUESTED
        const firebaseConfig = {
            apiKey: "AIzaSyDzIgNO0yPUpwCPS2yM9UG0Elvt1b25kG0",
            authDomain: "postitch-9294d.firebaseapp.com",
            projectId: "postitch-9294d", 
            storageBucket: "postitch-9294d.firebaseapp.com",
            messagingSenderId: "712159052688",
            appId: "1:712159052688:web:dc6e6e299db3cf011ee915",
            measurementId: "G-55JMQ5RPG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Analytics initialized here

        // Using projectId from the hardcoded config as the appId for Firestore paths.
        // This is crucial for matching the Firestore security rules.
        const appId = firebaseConfig.projectId; 

        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allFetchedPosts = []; // This will now hold ALL posts fetched by onSnapshot
        let isAuthReady = false; // Flag to ensure Firestore operations wait for authentication to complete.
        let displayLimit = 9; // Number of posts to load per page initially
        const postsPerPage = 9; // Number of posts to load per page
        let currentSortBy = 'newest'; // Default sort order for community feed
        let currentPricingFilter = 'all'; // Default pricing filter
        let currentAiContentFilter = 'all'; // New: Default AI content filter

        // Global array to store selected genres, persisting across search filters
        let selectedGenres = []; 
        
        // Define genres globally so renderGenreCheckboxes can access it
        const genres = ["2D", "3D", "4X", "Abstract", "Action", "Action-Adventure", "Adventure", "Arcade", "Arena Shooter", "ARPG", "Battle Royale", "Building", "Bullet Hell", "Casual", "Challenging", "City-builder", "Comedy", "Cooking", "Co-op", "Crafting", "CRPG", "Cultivation", "Cyberpunk", "Dating Sim", "Deck-builder", "Deckbuilding Roguelike", "Demo", "Detective", "Dex-builder", "Dinosaur", "Documentary", "Drama", "Driving", "Dungeon Crawler", "Early Access", "Educational", "Endless Runner", "Exploration", "Fantasy", "Farming Sim", "Fashion", "Fast-Paced", "Fighting", "First-Person", "Fishing", "Fitness", "Free to Play", "Full Release", "Futuristic", "Gacha", "Gambling", "God Game", "Golf", "Grand Strategy", "Hack and Slash", "Hero Collector", "Historical", "Horror", "Hunting", "Idle Game", "Immersive Sim", "Incremental Game", "Indie", "Interactive Fiction", "JRPG", "Kaiju", "Kids", "Language", "Life Sim", "Logic", "Low-Poly", "Management", "Martial Arts", "Medical", "Medieval", "Mecha", "Metroidvania", "Metroidvania-lite", "Military", "Minimalist", "MMO", "Modern", "Monster Tamer", "Multiplayer", "Music", "Mystery", "Mythology", "Narrative", "Naval", "Ninja", "Non-linear", "Noir", "Open World", "Parkour", "Party", "Party Game", "Pay What You Want", "Philosophical", "Physics", "Pinball", "Pirate", "Pixel Art", "Platform Fighter", "Platformer", "Point & Click", "Post-Apocalyptic", "Precision Platformer", "Procedural Generation", "Programming", "Psychological Horror", "Puzzle", "Puzzle-Platformer", "Quick-Time Event", "Quiz", "Racing", "Real-Time Strategy", "Relaxing", "Remake", "Remaster", "Retro", "Rhythm", "Roguelike", "Rogue-lite", "Roguelite", "Role-Playing", "RPG", "RTS", "Run and Gun", "Sandbox", "Sandbox RPG", "Sci-Fi", "Sci-Fi RPG", "Shoot 'em Up", "Shooter", "Side-Scroller", "Simulation", "Simulation RPG", "Singleplayer", "Skateboarding", "Slice of Life", "Slow-Paced", "Social Deduction", "Solitaire", "Souls-like", "Space", "Sports", "Stealth", "Steampunk", "Story", "Story-Rich", "Strategy", "Strategy RPG", "Superhero", "Supernatural", "Surreal", "Survival", "Survival Horror", "Tabletop", "Tactical RPG", "Tactical Shooter", "Team-Based", "Tech Demo", "Text Adventure", "Third-Person", "Thriller", "Time Management", "Time Travel", "Top-Down", "Top-Down Shooter", "Tower Defense", "Trading", "Train", "Transhumanism", "Travel", "Trigonometry", "Trivia", "Turn-Based Strategy", "Typing", "Uplifting", "Urban Fantasy", "Vampire", "Vehicular Combat", "Vertical Shooter", "Visual Novel", "Visual Novel Comedy", "Visual Novel Drama", "Visual Novel Fantasy", "Visual Novel Horror", "Visual Novel Mystery", "Visual Novel RPG", "Visual Novel Romance", "Visual Novel Sci-Fi", "Visual Novel Slice of Life", "Visual Novel Thriller", "Voxel Art", "Walking Simulator", "War", "Western", "Werewolf", "Word Game", "Wrestling", "Zombies", "Zoo", "Zork-like"];


        // User settings state - now initialized from local storage or defaults
        let userSettings = {
            theme: 'system', // 'system', 'light', 'dark'
            textSize: 'base', // 'sm', 'base', 'lg'
            animations: true, // true, false
            showPostCounts: true, // true, false
            defaultPostType: 'Game Promotion', // 'Game Promotion', 'Devlog'
            defaultSortOrder: 'newest', // 'newest', 'popular', 'oldest', 'most-viewed', 'most-visited'
            defaultPostCountDisplay: 'abbreviated', // 'exact', 'abbreviated' - Default changed to 'abbreviated'
            modalFullscreen: false, // New setting: automatically open modals in fullscreen
            alwaysMuteVideos: false // New setting: always mute videos when opened
        };

        // Map to store last view timestamp for each post to prevent spamming views
        // Key: postId, Value: timestamp (Date.now())
        const lastViewTimestamps = new Map();
        const VIEW_COOLDOWN_MS = 10000; // 10 seconds cooldown for view increments

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        const contentCommunity = document.getElementById('content-community');
        const contentPromos = document.getElementById('content-promos'); // New
        const contentDevlogs = document.getElementById('content-devlogs'); // New
        const contentPost = document.getElementById('content-post');
        const contentSearch = document.getElementById('content-search');
        const contentMyPosts = document.getElementById('content-my-posts');
        const contentAbout = document.getElementById('content-about');
        const contentRules = document.getElementById('content-rules');
        const contentSettings = document.getElementById('content-settings'); // New Settings content

        const postModal = document.getElementById('post-modal');
        const modalContent = document.getElementById('modal-content');
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmInputModal = document.getElementById('confirm-input-modal'); // New confirmation input modal
        const linkModal = document.getElementById('link-modal'); // New link modal

        // New video modal elements
        const videoModal = document.getElementById('video-modal');
        const videoModalContent = document.getElementById('video-modal-content');
        const videoPlayerContainer = document.getElementById('video-player-container'); // Container for YouTube player
        const closeVideoModalBtn = document.getElementById('close-video-modal-btn');
        const fullscreenVideoToggleBtn = document.getElementById('fullscreen-video-toggle-btn'); // New fullscreen toggle for video modal

        // New AI Assistant modal elements
        const aiAssistantModal = document.getElementById('ai-assistant-modal');
        const closeAiAssistantModalBtn = document.getElementById('close-ai-assistant-modal-btn');

        // Array of all modal elements for easy iteration
        const allModalElements = [
            postModal,
            alertModal,
            confirmModal,
            confirmInputModal,
            videoModal,
            aiAssistantModal,
            linkModal // Add link modal to the list
        ];


        let editingPostId = null; // Stores the ID of the post currently being edited
        let isPostModalOpen = false; // Flag to prevent multiple modal instances
        let youtubePlayer = null; // Global YouTube player instance for the main post modal

        // This function is called by the YouTube IFrame Player API when it's ready
        window.onYouTubeIframeAPIReady = () => {
            console.log("YouTube IFrame API is ready.");
            // Player will be initialized when a video is opened in the modal
        };

        // --- HELPER FUNCTIONS ---
        // Updates the body's overflow property based on modal visibility.
        function updateBodyScrollLock() {
            const isAnyModalOpen = allModalElements.some(modal => !modal.classList.contains('hidden'));
            if (isAnyModalOpen) {
                document.body.classList.add('modal-fullscreen-active');
            } else {
                document.body.classList.remove('modal-fullscreen-active');
            }
        }

        // Updates the document title
        function updateDocumentTitle(suffix = '') {
            if (suffix) {
                document.title = `${suffix} - PostItch`;
            } else {
                document.title = 'PostItch';
            }
        }

        // Displays a custom alert message to the user.
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
            updateBodyScrollLock(); // Ensure body scroll is locked
            return new Promise(resolve => {
                document.getElementById('alert-ok-btn').onclick = () => {
                    alertModal.classList.add('hidden');
                    updateBodyScrollLock(); // Update body scroll lock after closing
                    resolve();
                };
            });
        }

        // Displays a custom confirmation dialog to the user.
        function showConfirm(message) {
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            updateBodyScrollLock(); // Ensure body scroll is locked
            return new Promise(resolve => {
                document.getElementById('confirm-yes-btn').onclick = () => {
                    confirmModal.classList.add('hidden');
                    updateBodyScrollLock(); // Update body scroll lock after closing
                    resolve(true);
                };
                document.getElementById('confirm-no-btn').onclick = () => {
                    confirmModal.classList.add('hidden');
                    updateBodyScrollLock(); // Update body scroll lock after closing
                    resolve(false);
                };
            });
        }

        // Displays a custom confirmation dialog with a text input.
        function showConfirmWithInput(message, expectedText) {
            const messageEl = document.getElementById('confirm-input-message');
            const expectedTextEl = document.getElementById('confirm-input-expected-text');
            const inputField = document.getElementById('confirm-input-field');
            const confirmBtn = document.getElementById('confirm-input-yes-btn');
            const cancelBtn = document.getElementById('confirm-input-no-btn');

            messageEl.textContent = message;
            expectedTextEl.textContent = `Type "${expectedText}" exactly to confirm:`;
            inputField.value = ''; // Clear previous input
            confirmBtn.disabled = true; // Disable confirm button initially
            confirmInputModal.classList.remove('hidden');
            updateBodyScrollLock(); // Ensure body scroll is locked

            return new Promise(resolve => {
                const inputListener = () => {
                    confirmBtn.disabled = (inputField.value !== expectedText);
                };

                inputField.addEventListener('input', inputListener);

                confirmBtn.onclick = () => {
                    inputField.removeEventListener('input', inputListener);
                    confirmInputModal.classList.add('hidden');
                    updateBodyScrollLock(); // Update body scroll lock after closing
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    inputField.removeEventListener('input', inputListener);
                    confirmInputModal.classList.add('hidden');
                    updateBodyScrollLock(); // Update body scroll lock after closing
                    resolve(false);
                };
            });
        }
        
        // Extracts the YouTube video ID from a given URL.
        function getYouTubeVideoId(url) {
            if (!url) return '';
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                } else if (urlObj.hostname.includes('youtu.be')) {
                    videoId = urlObj.pathname.slice(1);
                }
            } catch (e) { /* Invalid URL, videoId remains null */ }
            return videoId;
        }

        // Generates the YouTube thumbnail URL.
        function getYouTubeThumbnailUrl(videoId) {
            return videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : '';
        }

        // Generates the YouTube embed source URL.
        function getYouTubeEmbedSrc(videoId, autoplay = false) {
            const muteParam = userSettings.alwaysMuteVideos ? '&mute=1' : '';
            return videoId ? `https://www.youtube.com/embed/${videoId}?enablejsapi=1${autoplay ? '&autoplay=1' : ''}${muteParam}` : '';
        }

        // Loads the YouTube video by replacing the thumbnail with the iframe.
        function loadYouTubeVideo(containerElement, videoId) {
            console.log("loadYouTubeVideo called for videoId:", videoId, "on container:", containerElement);
            const embedSrc = getYouTubeEmbedSrc(videoId, true); // Autoplay when clicked
            if (embedSrc) {
                // Ensure the container has a defined height for the iframe to render correctly
                containerElement.innerHTML = `<iframe class="w-full h-full rounded-none" src="${embedSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                console.log("Iframe embedded:", embedSrc);
            } else {
                console.warn("No valid YouTube embed source generated for videoId:", videoId);
            }
        }

        // Generates the HTML for embedding an Itch.io game.
        function getItchEmbedHtml(itchLink) {
            if (!itchLink) return '';
            // Itch.io often prevents embedding on external sites due to security policies (e.g., X-Frame-Options).
            // We will display a message and a direct link instead of trying to embed directly.
            return `<div class="w-full h-full bg-[#101010] flex flex-col items-center justify-center text-gray-500 p-4 text-center rounded-t-lg">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p class="mb-2">Direct Itch.io embedding is often restricted.</p>
                        <a href="${itchLink}" target="_blank" class="text-[#00bcd4] hover:underline">Visit Itch.io Page</a>
                    </div>`;
        }

        // Opens the dedicated video modal
        function openVideoModal(videoId, videoTitle = 'Video') {
            const embedSrc = getYouTubeEmbedSrc(videoId, true); // Always autoplay when opened via dedicated button
            if (embedSrc) {
                // Clear previous content
                videoPlayerContainer.innerHTML = '';
                // Create a new div for the YouTube player
                const playerDiv = document.createElement('div');
                playerDiv.id = 'youtube-modal-player';
                videoPlayerContainer.appendChild(playerDiv);

                // Initialize YouTube player
                youtubePlayer = new YT.Player('youtube-modal-player', {
                    videoId: videoId,
                    playerVars: {
                        autoplay: 1,
                        controls: 1,
                        modestbranding: 1,
                        rel: 0,
                        showinfo: 0,
                        iv_load_policy: 3,
                        mute: userSettings.alwaysMuteVideos ? 1 : 0 // Apply mute setting
                    },
                    events: {
                        'onReady': (event) => {
                            event.target.playVideo();
                        }
                    }
                });

                videoModal.classList.remove('hidden');
                updateBodyScrollLock(); // Ensure body scroll is locked
                updateDocumentTitle(videoTitle); // Update title for video modal

                // Update URL
                const url = new URL(window.location.href);
                url.searchParams.set('videoId', videoId);
                url.searchParams.delete('postId'); // Remove postId if present
                url.searchParams.delete('modal'); // Remove other modal params
                window.history.pushState({}, '', url.toString());

                // Apply fullscreen if setting is enabled
                if (userSettings.modalFullscreen) {
                    toggleFullscreen(videoModalContent, true); // Pass true to force fullscreen on open
                }
            } else {
                showAlert("Could not play video: Invalid YouTube link.");
            }
        }

        // Closes the dedicated video modal
        function closeVideoModal() {
            videoModal.classList.add('hidden');
            if (youtubePlayer) {
                youtubePlayer.destroy(); // Destroy the player to stop video and release resources
                youtubePlayer = null;
            }
            videoPlayerContainer.innerHTML = ''; // Clear the container
            // Ensure fullscreen mode is off when closing the video modal
            toggleFullscreen(videoModalContent, false); // Force fullscreen off on close
            updateBodyScrollLock(); // Update body scroll lock after closing
            updateDocumentTitle(document.querySelector('.nav-item.active')?.textContent || 'Community'); // Reset title
            // Remove videoId from URL
            const url = new URL(window.location.href);
            url.searchParams.delete('videoId');
            window.history.replaceState({}, document.title, url.toString());
        }

        // Opens the AI Assistant modal
        function openAiAssistantModal() {
            aiAssistantModal.classList.remove('hidden');
            updateBodyScrollLock(); // Ensure body scroll is locked
            updateDocumentTitle('Posty AI'); // Update title for AI assistant modal

            // Update URL
            const url = new URL(window.location.href);
            url.searchParams.set('modal', 'ai-assistant');
            url.searchParams.delete('postId'); // Remove postId if present
            url.searchParams.delete('videoId'); // Remove videoId if present
            window.history.pushState({}, '', url.toString());
        }

        // Closes the AI Assistant modal
        function closeAiAssistantModal() {
            aiAssistantModal.classList.add('hidden');
            updateBodyScrollLock(); // Update body scroll lock after closing
            updateDocumentTitle(document.querySelector('.nav-item.active')?.textContent || 'Community'); // Reset title
            // Remove modal param from URL
            const url = new URL(window.location.href);
            url.searchParams.delete('modal');
            window.history.replaceState({}, document.title, url.toString());
        }


        // Function to render genre checkboxes based on a filtered list
        // Moved to global scope for accessibility
        function renderGenreCheckboxes(targetContainer, filterTerm = '') {
            console.log("renderGenreCheckboxes called with filterTerm:", filterTerm);
            const lowerCaseFilterTerm = filterTerm.toLowerCase();
            const filteredGenres = genres.filter(g => g.toLowerCase().includes(lowerCaseFilterTerm));
            console.log("Filtered genres count:", filteredGenres.length);

            targetContainer.innerHTML = filteredGenres
                .map(g => {
                    const isChecked = selectedGenres.includes(g) ? 'checked' : '';
                    const isHighlighted = lowerCaseFilterTerm && g.toLowerCase().includes(lowerCaseFilterTerm) ? 'genre-highlight' : '';
                    return `<label class="custom-checkbox"><input type="checkbox" name="genre" value="${g}" ${isChecked}><span class="${isHighlighted}">${g}</span></label>`;
                }).join('');

            // Update search status message (assuming a status element exists near the genre checkboxes)
            const genreSearchStatus = document.getElementById('genre-search-status'); // This needs to be globally accessible or passed
            if (genreSearchStatus) { // Check if element exists before manipulating
                if (filterTerm) {
                    genreSearchStatus.textContent = `Showing genres matching "${filterTerm}"`;
                    genreSearchStatus.classList.remove('hidden');
                } else {
                    genreSearchStatus.classList.add('hidden');
                }
            }
        }

        // Helper function to format numbers (e.g., 1250 -> 1.3k)
        function formatNumberForDisplay(num) {
            if (num === undefined || num === null) return 0;
            if (userSettings.defaultPostCountDisplay === 'abbreviated' && num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        /**
         * Strips Markdown formatting from a given text string.
         * This includes bold, italic, links (keeps display text), inline code, blockquotes, and list items.
         * @param {string} markdownText The text containing Markdown.
         * @returns {string} The text with Markdown stripped.
         */
        function stripMarkdown(markdownText) {
            if (!markdownText) return '';
            let cleanedText = markdownText;

            // Remove bold (**text**)
            cleanedText = cleanedText.replace(/\*\*(.*?)\*\*/g, '$1');
            // Remove italic (*text*)
            cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');
            // Remove links ([text](url)) - keep only the display text
            cleanedText = cleanedText.replace(/\[(.*?)\]\(.*?\)/g, '$1');
            // Remove inline code (`code`)
            cleanedText = cleanedText.replace(/`(.*?)`/g, '$1');
            // Remove blockquote prefix (> )
            cleanedText = cleanedText.replace(/^>\s*/gm, '');
            // Remove list item prefix (- )
            cleanedText = cleanedText.replace(/^- \s*/gm, '');
            // Remove horizontal rule (---)
            cleanedText = cleanedText.replace(/^---\s*$/gm, '');
            // Replace multiple newlines with single newlines to prevent excessive spacing
            cleanedText = cleanedText.replace(/\n\s*\n/g, '\n\n');
            // Trim leading/trailing whitespace
            cleanedText = cleanedText.trim();

            return cleanedText;
        }

        /**
         * Converts Markdown text to HTML.
         * @param {string} markdownText The text containing Markdown.
         * @returns {string} The HTML representation of the Markdown.
         */
        function convertMarkdownToHtml(markdownText) {
            if (!markdownText) return '';
            let html = markdownText;

            // Process Horizontal Rule first
            html = html.replace(/^---\s*$/gm, '<hr>');

            // Process Blockquotes
            html = html.replace(/^>\s*(.*)$/gm, '<blockquote>$1</blockquote>');

            // Process Lists
            let lines = html.split('\n');
            let processedLines = [];
            let inList = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                if (line.startsWith('- ')) {
                    if (!inList) {
                        processedLines.push('<ul>');
                        inList = true;
                    }
                    processedLines.push(`<li>${line.substring(2)}</li>`);
                } else {
                    if (inList) {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    processedLines.push(line); // Keep non-list lines as is for now
                }
            }
            if (inList) { // Close list if it was open at the end
                processedLines.push('</ul>');
            }
            html = processedLines.join('\n'); // Rejoin lines, now lists are properly structured

            // Process Inline elements (Bold, Italic, Code, Links)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Handle Paragraphs: Replace double newlines with </p><p>, single newlines with <br> within paragraphs
            // This should happen AFTER all block-level processing.
            let paragraphs = html.split(/\n\s*\n/); // Split by one or more blank lines
            html = paragraphs.map(p => {
                // If a paragraph contains a block element (like ul, blockquote, hr), don't wrap it in <p>
                if (p.includes('<ul') || p.includes('<blockquote') || p.includes('<hr>')) {
                    return p; // Return as is, it's already structured or will be handled by CSS
                }
                // Otherwise, wrap in <p> and convert single newlines to <br>
                return `<p>${p.replace(/\n/g, '<br>')}</p>`;
            }).join('');

            // Clean up any empty paragraph tags that might have been created
            html = html.replace(/<p>\s*<\/p>/g, '');
            
            // Remove <p> tags directly before/after block elements if they somehow slipped through
            html = html.replace(/<p>(<ul|<blockquote|<hr>)/g, '$1');
            html = html.replace(/(<\/ul>|<\/blockquote>|<hr>)<\/p>/g, '$1');

            return html;
        }

        // --- SETTINGS FUNCTIONS ---
        // Applies the current theme, text size, and animation settings to the body.
        function applySettings() {
            const body = document.body;

            // Apply theme
            body.classList.remove('light-mode', 'dark-mode');
            if (userSettings.theme === 'light') {
                body.classList.add('light-mode');
            } else if (userSettings.theme === 'dark') {
                body.classList.add('dark-mode'); // Currently same as default, but good for explicit control
            } else { // System preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    body.classList.add('light-mode');
                }
            }

            // Apply text size
            body.classList.remove('text-sm', 'text-base', 'text-lg');
            body.classList.add(`text-${userSettings.textSize}`);

            // Apply animations preference
            if (userSettings.animations) {
                body.classList.remove('no-animations');
            } else {
                body.classList.add('no-animations');
            }

            // Re-render current page to apply changes that affect post cards (e.g., count display)
            const activeTab = document.querySelector('.nav-item.active')?.getAttribute('data-tab') || 'community';
            // currentSortBy is always 'newest' now as the setting is removed.
            currentSortBy = 'newest';

            if (activeTab === 'community') {
                renderCommunityPage();
            } else if (activeTab === 'my-posts') {
                renderMyPostsPage();
            } else if (activeTab === 'promos') {
                renderPromosPage();
            } else if (activeTab === 'devlogs') {
                renderDevlogsPage();
            } else if (activeTab === 'search') {
                handleSearch(); // Re-run search to apply changes
            }
        }

        // Saves user settings to Local Storage.
        function saveUserSettings() {
            try {
                localStorage.setItem('userSettings', JSON.stringify(userSettings));
                console.log("User settings saved to local storage:", userSettings);
            } catch (error) {
                console.error("Error saving user settings to local storage:", error);
            }
        }

        // Loads user settings from Local Storage.
        function loadUserSettings() {
            try {
                const storedSettings = localStorage.getItem('userSettings');
                if (storedSettings) {
                    userSettings = { ...userSettings, ...JSON.parse(storedSettings) };
                    console.log("User settings loaded from local storage:", userSettings);
                } else {
                    console.log("No user settings found in local storage, using defaults.");
                }
                applySettings(); // Apply loaded or default settings immediately
            } catch (error) {
                console.error("Error loading user settings from local storage:", error);
            }
        }

        // Global variables for link modal handlers
        let linkModalUrlInput;
        let linkModalTextInput;
        let linkModalInsertBtn;
        let linkModalCancelBtn;
        let descriptionInputForLink; // To hold the reference to the main description input
        let linkSelectionStart;
        let linkSelectionEnd;

        // Opens the link insertion modal
        function openLinkModal(start, end) {
            linkModal.classList.remove('hidden');
            updateBodyScrollLock();
            linkSelectionStart = start;
            linkSelectionEnd = end;
            // Pre-fill text input if something was selected
            linkModalTextInput.value = descriptionInputForLink.value.substring(start, end);
            linkModalUrlInput.focus(); // Focus URL input
            // Validate initially in case there's pre-filled text
            linkModalInsertBtn.disabled = !linkModalUrlInput.value.trim().match(/^https?:\/\/[^\s$.?#].[^\s]*$/i);
        }

        // Initialize link modal handlers ONCE
        function initializeLinkModalHandlers() {
            linkModalUrlInput = document.getElementById('link-url-input');
            linkModalTextInput = document.getElementById('link-text-input');
            linkModalInsertBtn = document.getElementById('insert-link-btn');
            linkModalCancelBtn = document.getElementById('cancel-link-btn');
            // linkModal is already a global const

            const validateLinkInput = () => {
                linkModalInsertBtn.disabled = !linkModalUrlInput.value.trim().match(/^https?:\/\/[^\s$.?#].[^\s]*$/i);
            };

            const handleInsertLink = () => {
                const url = linkModalUrlInput.value.trim();
                const text = linkModalTextInput.value.trim() || url; // Use URL if text is empty
                const linkMarkdown = `[${text}](${url})`;

                if (descriptionInputForLink) { // Ensure we have a reference to the textarea
                    const currentValue = descriptionInputForLink.value;
                    descriptionInputForLink.value = currentValue.substring(0, linkSelectionStart) + linkMarkdown + currentValue.substring(linkSelectionEnd);
                    descriptionInputForLink.selectionStart = linkSelectionStart + linkMarkdown.length;
                    descriptionInputForLink.selectionEnd = linkSelectionStart + linkMarkdown.length;
                    descriptionInputForLink.focus();
                    // Manually trigger input event to update char count and preview
                    descriptionInputForLink.dispatchEvent(new Event('input', { bubbles: true }));
                }
                closeLinkModal();
            };

            const closeLinkModal = () => {
                linkModal.classList.add('hidden');
                updateBodyScrollLock();
                // Clear inputs and reset button state when closing
                linkModalUrlInput.value = '';
                linkModalTextInput.value = '';
                linkModalInsertBtn.disabled = true; 
            };

            // Attach listeners ONCE
            linkModalInsertBtn.addEventListener('click', handleInsertLink);
            linkModalCancelBtn.addEventListener('click', closeLinkModal);
            linkModalUrlInput.addEventListener('input', validateLinkInput);
        }


        // --- EVENT LISTENERS SETUP ---
        // Attaches event listeners to dynamically created post cards.
        function addCardEventListeners(isMyPostPage = false) {
document.querySelectorAll('.card-bg').forEach(card => {
    card.addEventListener('click', async (e) => {
        // Check if a child button (like, comment, edit, delete, play, combo) was clicked
        const isButtonClick = e.target.closest('button, a.btn');
        if (isButtonClick && !isButtonClick.classList.contains('play-button-overlay') && !isButtonClick.classList.contains('combo-video-btn')) {
            // If it's a button click, prevent opening the modal immediately.
            // Let the button's own event handler (e.g., for like/comment) handle it.
            // This ensures the card doesn't open when liking, commenting, etc.
            console.log("Button clicked, preventing card modal open.");
            return; // Stop further processing for the card click
        }

        const postId = card.dataset.id;
        // Only open the post modal if it's not already open
        if (!isPostModalOpen) {
            await openPostModal(postId, false, true); // Explicitly increment view for user-initiated open
        }
    });
});

            // Event listener for playing YouTube videos from thumbnail (for 'youtube' media type)
            document.querySelectorAll('.media-placeholder[data-video-id]').forEach(placeholder => {
                placeholder.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click event from firing
                    const videoId = placeholder.dataset.videoId;
                    loadYouTubeVideo(placeholder, videoId);
                });
            });
            
            // Event listener for combo video button on preview cards
            document.querySelectorAll('.combo-video-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click event from firing
                    const videoId = btn.dataset.videoId;
                    // Find the post title for the video modal title
                    const postId = btn.closest('.card-bg')?.dataset.id;
                    const post = allFetchedPosts.find(p => p.id === postId);
                    const videoTitle = post ? post.title : 'Video';
                    openVideoModal(videoId, videoTitle);
                });
            });

            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); toggleLike(btn.dataset.id); });
            });

            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); openPostModal(btn.dataset.id, true, false); }); // Don't increment view when opening from comment button
            });

            // Only add delete/edit listeners if on My Posts page
            if (isMyPostPage) {
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const confirmed = await showConfirm("Are you sure you want to delete this post? This action cannot be undone.");
                        if (confirmed) {
                            try {
                                // Correct Firestore path for deletion, using the dynamic appId
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts`, btn.dataset.id));
                                showAlert("Post deleted successfully.");
                                // The real-time listener will automatically update the UI.
                            } catch (err) {
                                console.error("Error deleting post:", err);
                                showAlert(`Could not delete post: ${err.message || err}.`);
                            }
                        }
                    });
                });
                // Add event listener for edit buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditModal(btn.dataset.id);
                    });
                });
            }
        }

        // --- AUTHENTICATION & APP STARTUP ---
        // Listens for Firebase authentication state changes.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
            } else {
                // If no user is logged in, attempt to sign in anonymously.
                try {
                    await signInAnonymously(auth);
                    currentUser = auth.currentUser; // Update currentUser after successful sign-in
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showAlert(`Authentication failed: ${error.message}. Some features may not work.`);
                }
            }
            // Initialize app state only once after authentication is confirmed ready.
            if (!isAuthReady) {
                isAuthReady = true;
                initializeAppState();
            }
        });

        // Initializes the main application state after authentication.
		function initializeAppState() {
			console.log("PostItch App Initializing...");
			console.log("Using Firebase Project ID (as App ID):", appId);
			console.log("Firestore Collection Path for posts:", `artifacts/${appId}/public/data/posts`);
            loadUserSettings(); // Load settings immediately on app start
			loader.style.display = 'none'; // Hide the loading spinner
			listenForPostsRealtime(); // Start real-time listening for ALL posts
			setupNavListeners(); // Set up navigation event handlers
            initializeLinkModalHandlers(); // Initialize link modal handlers once

			// Check for URL parameters and handle routing
			const urlParams = new URLSearchParams(window.location.search);
			const postIdFromUrl = urlParams.get('postId');
			const sectionFromUrl = urlParams.get('section');
            const videoIdFromUrl = urlParams.get('videoId');
            const modalFromUrl = urlParams.get('modal');
            const searchQueryFromUrl = urlParams.get('query');

            if (postIdFromUrl) {
                // Wait for posts to be fetched before attempting to open the modal
                const checkPostsInterval = setInterval(() => {
                    if (allFetchedPosts.length > 0) {
                        clearInterval(checkPostsInterval);
                        openPostModal(postIdFromUrl, false, true, true); // Increment view, and indicate opened from URL
                    }
                }, 100); // Check every 100ms
            } else if (videoIdFromUrl) {
                // Wait for YouTube API to be ready
                const checkYoutubeAPIInterval = setInterval(() => {
                    if (typeof YT !== 'undefined' && YT.Player) {
                        clearInterval(checkYoutubeAPIInterval);
                        // Try to find the video title from existing posts if possible
                        const postWithVideo = allFetchedPosts.find(p => getYouTubeVideoId(p.trailerLink) === videoIdFromUrl);
                        const videoTitle = postWithVideo ? postWithVideo.title : 'Video';
                        openVideoModal(videoIdFromUrl, videoTitle);
                    }
                }, 100);
            } else if (modalFromUrl === 'ai-assistant') {
                openAiAssistantModal();
            } else if (sectionFromUrl === 'search' && searchQueryFromUrl) {
                document.getElementById('search-input').value = searchQueryFromUrl;
                switchTab('search');
                // handleSearch will be called by switchTab('search')
            } else if (sectionFromUrl) {
				switchTab(sectionFromUrl); // Switch to the specified section
			} else {
				switchTab('community'); // Load the default community feed tab if no specific URL param
			}
			// Add event listener for the new video modal close button
			closeVideoModalBtn.addEventListener('click', closeVideoModal);
            // Add event listener for the new video modal fullscreen toggle button
            fullscreenVideoToggleBtn.addEventListener('click', () => toggleFullscreen(videoModalContent));
            // Add event listener for AI Assistant modal close button
            closeAiAssistantModalBtn.addEventListener('click', closeAiAssistantModal);

            // Auto-pause video when any other modal opens or tab switches
            document.addEventListener('click', (e) => {
                if (!videoModal.classList.contains('hidden') && !e.target.closest('#video-modal')) {
                    // Check if the click is outside the video modal
                    // This is a broad check, refine if needed for specific interactions
                    pauseVideo();
                }
            });
            // Also pause video when tab switches
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (!videoModal.classList.contains('hidden')) {
                        pauseVideo();
                    }
                });
            });
        }
        
        // Function to pause the video in the video modal
        function pauseVideo() {
            if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') {
                youtubePlayer.pauseVideo();
            }
        }

        // Sets up event listeners for navigation buttons (desktop and mobile).
        function setupNavListeners() {
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.target.getAttribute('data-tab');
                    if (tab) {
                        // Update URL with section parameter
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('section', tab);
                        newUrl.searchParams.delete('postId'); // Remove postId if navigating to a section
                        newUrl.searchParams.delete('videoId'); // Remove videoId if navigating
                        newUrl.searchParams.delete('modal'); // Remove modal if navigating
                        // If navigating to search, keep query
                        if (tab !== 'search') {
                            newUrl.searchParams.delete('query');
                        }
                        window.history.pushState({}, '', newUrl.toString());
                        switchTab(tab);
                        mobileMenu.classList.add('hidden'); // Hide mobile menu on tab selection
                    }
                });
            });
        }

        // --- NAVIGATION LOGIC ---
        // Switches the active tab and renders its content.
        function switchTab(tab) {
            // Update active navigation item styling
            navItems.forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-tab') === tab);
            });
            // Show/hide corresponding tab content sections
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== `content-${tab}`);
            });
            
            // Map tab names to their respective rendering functions and titles
            const renderMap = {
                community: { func: renderCommunityPage, title: 'Community' },
                promos: { func: renderPromosPage, title: 'Game Promos' },
                devlogs: { func: renderDevlogsPage, title: 'Devlogs' },
                post: { func: () => renderPostPage(contentPost), title: 'Create Post' },
                search: { func: renderSearchPage, title: 'Search' },
                'my-posts': { func: renderMyPostsPage, title: 'My Posts' },
                about: { func: renderAboutPage, title: 'About' },
                rules: { func: renderRulesPage, title: 'Rules' },
                settings: { func: renderSettingsPage, title: 'Settings' },
            };
            const tabInfo = renderMap[tab];
            if (tabInfo) {
                tabInfo.func(); // Call the appropriate rendering function
                updateDocumentTitle(tabInfo.title); // Update document title
            } else {
                updateDocumentTitle('PostItch'); // Fallback title
            }
        }
        
        // Renders a single post card for display in community/search/my posts grids.
        function renderPostCard(post, isMyPostPage = false) { // Added isMyPostPage parameter
            const isAuthor = post.authorId === currentUser?.uid;
            let mediaHtml = '';
            let comboVideoBtnHtml = ''; // New variable for the combo video button on preview card
            const cardTypeClass = post.postType === 'Devlog' ? 'card-devlog' : 'card-promo';

            // Conditional rendering of media based on `mediaType` field
            if (post.mediaType === 'youtube' && post.trailerLink) {
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    const thumbnailUrl = getYouTubeThumbnailUrl(videoId);
                    mediaHtml = `
                        <div class="media-placeholder w-full h-full relative cursor-pointer" data-video-id="${videoId}">
                            <img src="${thumbnailUrl}" alt="YouTube Thumbnail" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Video+Not+Found';">
                            <div class="play-button-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    `;
                }
            } else if (post.mediaType === 'image' && post.imageUrl) {
                 mediaHtml = `<img src="${post.imageUrl}" alt="${post.title}" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Image+Not+Found';">`;
            } else if (post.mediaType === 'combo' && post.trailerLink && post.imageUrl) {
                // For combo, display the image on the preview card
                mediaHtml = `<img src="${post.imageUrl}" alt="Custom Thumbnail" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Custom+Thumbnail+Not+Found';">`;
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    // Add the combo video button to the preview card
                    comboVideoBtnHtml = `
                        <button class="combo-video-btn" data-video-id="${videoId}">
                            <i class="fab fa-youtube"></i> ${post.customYoutubeLinkText || 'Watch Trailer'}
                        </button>
                    `;
                }
            } else if (post.mediaType === 'itch_embed' && post.itchLink) {
                // For Itch.io, always show the placeholder due to embedding restrictions
                mediaHtml = getItchEmbedHtml(post.itchLink);
            }

            // Fallback content if no valid media is provided or selected (or mediaType is 'none')
            if (!mediaHtml || post.mediaType === 'none') {
                mediaHtml = `<div class="h-full bg-[#101010] flex items-center justify-center text-gray-500 rounded-t-lg"><i class="fas fa-image fa-3x"></i></div>`;
            }

            return `
                <div class="card-bg rounded-lg overflow-hidden flex flex-col cursor-pointer ${cardTypeClass}" data-id="${post.id}">
                    <div class="thumbnail-container">
                        ${mediaHtml}
                        ${comboVideoBtnHtml} <!-- Insert the combo video button here -->
                    </div>
                    
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-xl font-bold mb-2 truncate text-white">${post.title}</h3>
                        <p class="text-gray-400 text-sm mb-4 flex-grow">${stripMarkdown(post.description).substring(0, 100)}${post.description.length > 100 ? '...' : ''}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.genres && post.genres.slice(0, 3).map(g => `<span class="bg-gray-700 text-xs font-semibold px-2 py-1 rounded-full text-gray-200">${g}</span>`).join('')}
                            ${post.tags && post.tags.slice(0, 3).map(t => `<span class="bg-purple-700 text-xs font-semibold px-2 py-1 rounded-full text-gray-200">${t}</span>`).join('')}
                        </div>
                        ${userSettings.showPostCounts ? `
                            <div class="flex justify-between items-center mt-auto pt-2 border-t border-gray-700">
                                <div class="flex space-x-4 text-gray-400">
                                    <button class="like-btn hover:text-white transition" data-id="${post.id}">
                                        <i class="${post.likes?.includes(currentUser?.uid) ? 'fas text-red-500' : 'far'} fa-heart"></i>
                                        <span class="ml-1">${formatNumberForDisplay(post.likes?.length || 0)}</span>
                                    </button>
									<button class="comment-btn hover:text-white transition" data-id="${post.id}">
										<i class="${post.allowComments ? 'fas fa-comment' : 'fa-solid fa-comment-slash'}"></i>
										<span class="ml-1">${formatNumberForDisplay(post.comments?.length || 0)}</span>
									</button>
                                    <span class="inline-flex items-center">
                                        <button class="hover:text-white transition cursor-default">
                                            <i class="fas fa-eye mr-1"></i> <!-- Changed to solid eye icon -->
                                            <span class="ml-1">${formatNumberForDisplay(post.views || 0)}</span>
                                        </button>
                                    </span>
                                    ${post.postType === 'Game Promotion' ? `
                                        <span class="inline-flex items-center">
                                            <button class="hover:text-white transition cursor-default">
                                                <i class="fas fa-external-link-alt mr-1"></i> <!-- New visit icon -->
                                                <span class="ml-1">${formatNumberForDisplay(post.visits || 0)}</span>
                                            </button>
                                        </span>
                                    ` : ''}
                                </div>
                                ${isMyPostPage && isAuthor ? `
                                    <div class="flex space-x-2">
                                        <button class="edit-btn text-blue-500 hover:text-blue-400 transition" data-id="${post.id}"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-400 transition" data-id="${post.id}"><i class="fas fa-trash"></i></button>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            ${isMyPostPage && isAuthor ? `
                                <div class="flex justify-end mt-auto pt-2 border-t border-gray-700">
                                    <div class="flex space-x-2">
                                        <button class="edit-btn text-blue-500 hover:text-blue-400 transition" data-id="${post.id}"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-400 transition" data-id="${post.id}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            ` : ''}
                        `}
                    </div>
                </div>
            `;
        }
        
        // Helper function to render a grid of posts with filtering and sorting
        function renderPostsGrid(targetElement, posts, pageTitle, includePricingFilter = true, includeSortBy = true, includeAiContentFilter = true, isMyPostPage = false) {
            let filteredPosts = posts;

            if (includePricingFilter) {
                filteredPosts = filteredPosts.filter(post => {
                    if (currentPricingFilter === 'all') return true;
                    if (post.postType !== 'Game Promotion') return false;
                    return post.pricing === currentPricingFilter;
                });
            }

            if (includeAiContentFilter) {
                filteredPosts = filteredPosts.filter(post => {
                    if (currentAiContentFilter === 'all') return true;
                    return post.aiContent === currentAiContentFilter;
                });
            }

            let sortedPosts = [...filteredPosts];
            if (includeSortBy) {
                // Use the currentSortBy which is now updated by userSettings.defaultSortOrder
                if (currentSortBy === 'popular') sortedPosts.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0));
                else if (currentSortBy === 'newest') sortedPosts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                else if (currentSortBy === 'oldest') sortedPosts.sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate()); // Fixed: was comparing a to a
                else if (currentSortBy === 'most-viewed') sortedPosts.sort((a, b) => (b.views || 0) - (a.views || 0));
                else if (currentSortBy === 'most-visited') sortedPosts.sort((a, b) => (b.visits || 0) - (a.visits || 0));
            }

            const postsToDisplay = sortedPosts.slice(0, displayLimit);

            targetElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-white">${pageTitle}</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                        ${includePricingFilter ? `
                            <div class="custom-select w-full sm:w-auto">
                                <select id="pricing-filter" class="input-bg rounded-md p-2 pl-4 pr-8 w-full">
                                    <option value="all" ${currentPricingFilter === 'all' ? 'selected' : ''}>All Pricing</option>
                                    <option value="Free" ${currentPricingFilter === 'Free' ? 'selected' : ''}>Free</option>
                                    <option value="Paid" ${currentPricingFilter === 'Paid' ? 'selected' : ''}>Paid</option>
                                    <option value="Key Available" ${currentPricingFilter === 'Key Available' ? 'selected' : ''}>Key Available</option>
                                    <option value="On Promo" ${currentPricingFilter === 'On Promo' ? 'selected' : ''}>On Promo</option>
                                </select>
                            </div>
                        ` : ''}
                        ${includeAiContentFilter ? `
                            <div class="custom-select w-full sm:w-auto">
                                <select id="ai-content-filter" class="input-bg rounded-md p-2 pl-4 pr-8 w-full">
                                    <option value="all" ${currentAiContentFilter === 'all' ? 'selected' : ''}>AI Content (All)</option>
                                    <option value="Yes" ${currentAiContentFilter === 'Yes' ? 'selected' : ''}>Yes (AI Content)</option>
                                    <option value="No" ${currentAiContentFilter === 'No' ? 'selected' : ''}>No (No AI Content)</option>
                                </select>
                            </div>
                        ` : ''}
                        ${includeSortBy ? `
                            <div class="custom-select w-full sm:w-auto">
                                <select id="sort-by" class="input-bg rounded-md p-2 pl-4 pr-8 w-full">
                                    <option value="newest" ${currentSortBy === 'newest' ? 'selected' : ''}>Newest</option>
                                    <option value="popular" ${currentSortBy === 'popular' ? 'selected' : ''}>Most Popular</option>
                                    <option value="oldest" ${currentSortBy === 'oldest' ? 'selected' : ''}>Oldest</option>
                                    <option value="most-viewed" ${currentSortBy === 'most-viewed' ? 'selected' : ''}>Most Viewed</option>
                                    <option value="most-visited" ${currentSortBy === 'most-visited' ? 'selected' : ''}>Most Visited</option>
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
			 <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
				${postsToDisplay.length > 0 
					? postsToDisplay.map(post => renderPostCard(post, isMyPostPage)).join('') 
					: `<p class="col-span-full text-center text-gray-400">
						${isMyPostPage 
							? 'You haven’t posted anything yet. Start by sharing your first game!' 
							: 'No posts yet. Be the first to share your game!'}
					   </p>`}
			</div>
			<div id="load-more-container" class="flex justify-center mt-8">
				${displayLimit < filteredPosts.length 
					? `<button id="load-more-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
						Load More <i class="fas fa-arrow-down"></i>
					   </button>` 
					: `<p class="text-gray-400"></p>`}
			</div>
            `;

            if (includeSortBy) {
                const sortBySelect = targetElement.querySelector('#sort-by');
                if (sortBySelect) {
                    sortBySelect.addEventListener('change', (e) => {
                        currentSortBy = e.target.value;
                        displayLimit = postsPerPage; // Reset limit on sort change
                        renderPostsGrid(targetElement, posts, pageTitle, includePricingFilter, includeSortBy, includeAiContentFilter, isMyPostPage);
                    });
                }
            }
            if (includePricingFilter) {
                const pricingFilterSelect = targetElement.querySelector('#pricing-filter');
                if (pricingFilterSelect) {
                    pricingFilterSelect.addEventListener('change', (e) => {
                        currentPricingFilter = e.target.value;
                        displayLimit = postsPerPage; // Reset limit on filter change
                        renderPostsGrid(targetElement, posts, pageTitle, includePricingFilter, includeSortBy, includeAiContentFilter, isMyPostPage);
                    });
                }
            }
            if (includeAiContentFilter) {
                const aiContentFilterSelect = targetElement.querySelector('#ai-content-filter');
                if (aiContentFilterSelect) {
                    aiContentFilterSelect.addEventListener('change', (e) => {
                        currentAiContentFilter = e.target.value;
                        displayLimit = postsPerPage; // Reset limit on filter change
                        renderPostsGrid(targetElement, posts, pageTitle, includePricingFilter, includeSortBy, includeAiContentFilter, isMyPostPage);
                    });
                }
            }

            addCardEventListeners(isMyPostPage);

            const loadMoreBtn = targetElement.querySelector('#load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    // Add loading animation
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.innerHTML = `<span class="spinner"></span> Loading...`;
                    loadMoreBtn.classList.add('animate-pulse'); // Add Tailwind pulse animation

                    displayLimit += postsPerPage;
                    renderPostsGrid(targetElement, posts, pageTitle, includePricingFilter, includeSortBy, includeAiContentFilter, isMyPostPage);
                    // The button will be re-rendered by renderPostsGrid, effectively resetting its state.
                });
            }
        }


        // Renders the main community feed page.
        function renderCommunityPage() {
            const communityPosts = allFetchedPosts.filter(p => p.postType === 'Game Promotion' || p.postType === 'Devlog');
            renderPostsGrid(contentCommunity, communityPosts, "Community Feed", true, true, true, false); // Pass false for isMyPostPage
        }

        // Renders the Game Promos page.
        function renderPromosPage() {
            const promoPosts = allFetchedPosts.filter(p => p.postType === 'Game Promotion');
            renderPostsGrid(contentPromos, promoPosts, "Game Promotions", true, true, true, false); // Pass false for isMyPostPage
        }

        // Renders the Devlogs page.
        function renderDevlogsPage() {
            const devlogPosts = allFetchedPosts.filter(p => p.postType === 'Devlog');
            renderPostsGrid(contentDevlogs, devlogPosts, "Devlogs", false, true, true, false); // Pass false for isMyPostPage
        }

        // New function to calculate visible character count by stripping markdown
        function getVisibleCharCount(markdownText) {
            return stripMarkdown(markdownText).length;
        }

        // Moved to global scope
        function toggleMediaSections(form) {
            const selectedMedia = form.querySelector('input[name="media-type"]:checked')?.value;
            console.log("toggleMediaSections called. Selected Media:", selectedMedia);

            const youtubeLinkSection = form.querySelector('#youtube-link-section');
            const imageLinkSection = form.querySelector('#image-link-section');
            const customYoutubeLinkSection = form.querySelector('#custom-youtube-text-section');
            const trailerLinkInput = form.querySelector('#trailer-link');
            const imageUrlInput = form.querySelector('#image-url');
            const customYoutubeLinkTextInput = form.querySelector('#custom-youtube-link-text');
            const youtubeLinkHelp = form.querySelector('.youtube-link-help');
            const imageLinkHelp = form.querySelector('.image-link-help');

            // Reset visibility and required attributes for all media sections first
            [youtubeLinkSection, imageLinkSection, customYoutubeLinkSection].forEach(el => el?.classList.add('hidden'));
            [trailerLinkInput, imageUrlInput, customYoutubeLinkTextInput].forEach(input => input?.removeAttribute('required'));

            if (selectedMedia === 'combo') {
                youtubeLinkSection?.classList.remove('hidden');
                imageLinkSection?.classList.remove('hidden');
                customYoutubeLinkSection?.classList.remove('hidden');
                
                if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Required for Combo. Example: https://youtu.be/dQw4w9WgXcQ)';
                if (imageLinkHelp) imageLinkHelp.textContent = '(Required for Combo. Example: https://example.com/your-game-screenshot.png)';
                trailerLinkInput?.setAttribute('required', 'true');
                imageUrlInput?.setAttribute('required', 'true');
                customYoutubeLinkTextInput?.setAttribute('required', 'true');
            } else if (selectedMedia === 'youtube') {
                youtubeLinkSection?.classList.remove('hidden');
                if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)';
                trailerLinkInput?.setAttribute('required', 'true');
            } else if (selectedMedia === 'image') {
                imageLinkSection?.classList.remove('hidden');
                if (imageLinkHelp) imageLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
                imageUrlInput?.setAttribute('required', 'true');
            } else { // 'none'
                if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)';
                if (imageLinkHelp) imageLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
            }
        }

        // Moved to global scope
        function togglePostTypeFields(form, post) { // Added 'post' parameter for edit mode
            const postTypeSelect = form.querySelector('#post-type');
            const devlogTypeSelect = form.querySelector('#devlog-type');
            const devlogTypeSection = form.querySelector('#devlog-type-section');
            const gamePromoPollToggle = form.querySelector('#game-promo-poll-toggle');
            const addGamePromoPollRadios = form.querySelectorAll('input[name="add-game-promo-poll"]');
            const pollSection = form.querySelector('#poll-section');
            const pollQuestionInput = form.querySelector('#poll-question');
            const pollOptionInputs = form.querySelectorAll('.poll-option-input');

            const genreSection = form.querySelector('#genre-section');
            const platformSection = form.querySelector('#platform-section');
            const pricingSection = form.querySelector('#pricing-section');
            const commentsStatusSection = form.querySelector('#comments-status-section');
            const linkedGamePromoSection = form.querySelector('#linked-game-promo-section');
            const itchLinkInput = form.querySelector('#itch-link');
            const itchLinkHelp = form.querySelector('#itch-link-help');

            const selectedPostType = postTypeSelect.value;
            const selectedDevlogType = devlogTypeSelect?.value;
            const addGamePromoPoll = form.querySelector('input[name="add-game-promo-poll"]:checked')?.value === 'true';

            // Reset all devlog specific fields to hidden and optional
            devlogTypeSection?.classList.add('hidden');
            gamePromoPollToggle?.classList.add('hidden');
            pollSection?.classList.add('hidden');

            // Crucially, remove required from poll inputs by default
            pollQuestionInput?.removeAttribute('required');
            pollOptionInputs.forEach(input => input.removeAttribute('required'));


            if (selectedPostType === 'Devlog') {
                devlogTypeSection?.classList.remove('hidden');
                genreSection?.classList.add('hidden');
                platformSection?.classList.add('hidden');
                pricingSection?.classList.add('hidden');
                commentsStatusSection?.classList.add('hidden');
                linkedGamePromoSection?.classList.remove('hidden');

                if (itchLinkInput) {
                    itchLinkInput.removeAttribute('required');
                    itchLinkInput.removeAttribute('pattern');
                }
                if (itchLinkHelp) itchLinkHelp.textContent = '(Optional for Devlog. Example: https://yourusername.itch.io/your-devlog-page)';
                document.querySelectorAll('#genre-section input[type="checkbox"]').forEach(checkbox => checkbox.required = false);
                document.querySelectorAll('#platform-section input[type="checkbox"]').forEach(checkbox => checkbox.required = false);

                if (selectedDevlogType === 'Poll') {
                    pollSection?.classList.remove('hidden');
                    pollQuestionInput?.setAttribute('required', 'true');
                    pollOptionInputs.forEach(input => input.setAttribute('required', 'true'));
                    updateRemovePollOptionButtons(form); // Pass form reference
                }
            } else { // Game Promotion
                devlogTypeSection?.classList.add('hidden');
                genreSection?.classList.remove('hidden');
                platformSection?.classList.remove('hidden');
                pricingSection?.classList.remove('hidden');
                commentsStatusSection?.classList.remove('hidden');
                linkedGamePromoSection?.classList.add('hidden');
                gamePromoPollToggle?.classList.remove('hidden');

                if (itchLinkInput) {
                    itchLinkInput.setAttribute('required', 'true');
                    itchLinkInput.setAttribute('pattern', 'https://.*\\.itch\\.io/.*');
                }
                if (itchLinkHelp) itchLinkHelp.textContent = '(Required for Game Promotion. Optional for Devlog. Example: https://yourusername.itch.io/your-game)';
                
                if (addGamePromoPoll) {
                    pollSection?.classList.remove('hidden');
                    pollQuestionInput?.setAttribute('required', 'true');
                    pollOptionInputs.forEach(input => input.setAttribute('required', 'true'));
                    updateRemovePollOptionButtons(form); // Pass form reference
                }
            }

            // If in edit mode and a poll already exists, disable poll fields
            if (post && post.poll) {
                if (pollSection) {
                    pollSection.classList.remove('hidden'); // Ensure poll section is visible
                    pollSection.querySelectorAll('input, button').forEach(element => {
                        element.disabled = true;
                        element.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    // Add a message indicating poll cannot be edited if not already there
                    if (!pollSection.querySelector('.poll-edit-message')) {
                        const pollMessage = document.createElement('p');
                        pollMessage.className = 'text-sm text-red-600 mb-4 poll-edit-message';
                        pollMessage.textContent = 'This post already has a poll. Polls cannot be modified or deleted after creation.';
                        pollSection.prepend(pollMessage);
                    }
                }
                // Also disable the 'Add Poll?' radio buttons if a poll exists
                addGamePromoPollRadios.forEach(radio => {
                    radio.disabled = true;
                    radio.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
                });
            } else {
                 // Ensure poll edit message is removed if no poll exists or it's a new post
                 pollSection?.querySelector('.poll-edit-message')?.remove();
                 addGamePromoPollRadios.forEach(radio => {
                    radio.disabled = false;
                    radio.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }
        }


        // Renders the form for creating a new post.
        function renderPostPage(targetElement) { // Now accepts a targetElement
            const platforms = ["Windows", "macOS", "Linux", "Android", "iOS", "Web / Browser", "Xbox", "PlayStation", "Nintendo Switch", "VR (Vive, Rift, Quest)", "AR"];
            const devlogTypes = ["Update", "Q&A", "Announcement", "Behind the Scenes", "Concept Art", "Development Progress", "Game Jam Entry", "Post-Mortem", "Release Info", "Tutorial", "Bug Fixes", "Roadmap", "Community Spotlight", "Poll", "Patch Notes", "Lore Deep Dive", "Music Showcase", "Art Showcase", "Level Design", "Character Design", "Story Development", "Technical Deep Dive", "Monetization", "Marketing", "Legal", "Other"];

            // Filter for only Game Promotion posts by the current user to link in Devlogs
            // Ensure currentUser and currentUser.uid are available before filtering
            const myGamePromoPosts = currentUser?.uid ? allFetchedPosts.filter(p => p.postType === 'Game Promotion' && p.authorId === currentUser.uid) : [];


            targetElement.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-white">${editingPostId ? 'Edit Your Post' : 'Share Your Game or Devlog'}</h2>
                    <form id="post-form" class="space-y-6">
                        <div>
                            <label for="post-type" class="block mb-2 font-semibold text-gray-300">What are you posting?</label>
                            <div class="custom-select">
                                <select id="post-type" class="w-full p-3 input-bg rounded-md" required ${editingPostId ? 'disabled' : ''}>
                                    <option value="Game Promotion" ${userSettings.defaultPostType === 'Game Promotion' ? 'selected' : ''}>Game Promotion</option>
                                    <option value="Devlog" ${userSettings.defaultPostType === 'Devlog' ? 'selected' : ''}>Devlog</option>
                                </select>
                            </div>
                        </div>

                        <div id="devlog-type-section" class="hidden">
                            <label for="devlog-type" class="block mb-2 font-semibold text-gray-300">Devlog Type</label>
                            <div class="custom-select">
                                <select id="devlog-type" class="w-full p-3 input-bg rounded-md">
                                    ${devlogTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div id="game-promo-poll-toggle" class="hidden">
                            <label class="block mb-2 font-semibold text-gray-300">Add Poll?</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="add-game-promo-poll" value="true">
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="add-game-promo-poll" value="false" checked>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div id="poll-section" class="hidden border-t border-gray-700 pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-400">Poll Details</h3>
                            <p class="text-sm text-red-600 mb-4">
                                Important: Polls cannot be deleted or modified after the post is first submitted.
                            </p>
                            <div>
                                <label for="poll-question" class="block mb-2 font-semibold text-gray-300">Poll Question</label>
                                <input type="text" id="poll-question" class="w-full p-3 input-bg rounded-md" placeholder="e.g., What feature should we add next?">
                            </div>
                            <div id="poll-options-container" class="mt-4 space-y-2">
                                <label class="block mb-2 font-semibold text-gray-300">Poll Options (Min 2, Max 5)</label>
                                <div class="flex gap-2">
                                    <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option 1" required>
                                    <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden"><i class="fas fa-minus"></i></button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option 2" required>
                                    <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <button type="button" id="add-poll-option-btn" class="btn-primary text-white font-bold py-2 px-4 rounded-md mt-4"><i class="fas fa-plus mr-2"></i>Add Option</button>
                        </div>


                        <div>
                            <label for="game-title" class="block mb-2 font-semibold text-gray-300">Title</label>
                            <input type="text" id="game-title" class="w-full p-3 input-bg rounded-md" required>
                        </div>
                        <div>
                            <label for="description" class="block mb-2 font-semibold text-gray-300">Description (100-1000 chars)</label>
                            <div class="flex flex-wrap gap-2 mb-2 w-full justify-between">
                                <button type="button" class="formatting-toolbar-btn" data-format="bold"><i class="fas fa-bold"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="italic"><i class="fas fa-italic"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="link"><i class="fas fa-link"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="bullet"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="inline-code"><i class="fas fa-code"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="blockquote"><i class="fas fa-quote-right"></i></button>
                                <button type="button" class="formatting-toolbar-btn" data-format="hr"><i class="fas fa-minus"></i></button>
                            </div>
                            <textarea id="description" rows="5" class="w-full p-3 input-bg rounded-md" minlength="100" maxlength="1000" required></textarea>
                            <p id="char-count" class="text-sm text-gray-400 mt-1 text-right">0/1000</p>
                            <div class="mt-4">
                                <label class="block mb-2 font-semibold text-gray-300">Live Preview:</label>
                                <div id="description-preview" class="input-bg p-3 rounded-md markdown-content"></div>
                            </div>
                        </div>
                        <div>
                            <label for="itch-link" class="block mb-2 font-semibold text-gray-300" id="itch-link-label">Itch.io Link</label>
                            <input type="url" id="itch-link" class="w-full p-3 input-bg rounded-md" pattern="https://.*\\.itch\\.io/.*" title="Please enter a valid itch.io URL.">
                            <p id="itch-link-help" class="text-sm text-gray-500 mt-1">
                                (Required for Game Promotion. Optional for Devlog. Example: https://yourusername.itch.io/your-game)
                            </p>
                        </div>
                        
                        <!-- Media Selection Section -->
                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-gray-300">Choose Media for Display</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="youtube" id="media-youtube" checked>
                                    <span>YouTube Trailer</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="image" id="media-image">
                                    <span>Image Link</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="combo" id="media-combo">
                                    <span>Combo</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="none" id="media-none">
                                    <span>None</span>
                                </label>
                            </div>
                        </div>

                        <div id="youtube-link-section">
                            <label for="trailer-link" class="block mb-2 font-semibold text-gray-300" id="trailer-link-label">
                                YouTube Link (Optional)
                                <span class="text-xs text-gray-500 ml-2 youtube-link-help">
                                    (e.g., from YouTube, click Share -> Copy Link. Example: https://youtu.be/dQw4w9WgXcQ)
                                </span>
                            </label>
                            <input type="url" id="trailer-link" class="w-full p-3 input-bg rounded-md" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                        </div>

                        <div id="image-link-section" class="hidden">
                            <label for="image-url" class="block mb-2 font-semibold text-gray-300" id="image-url-label">
                                Image URL (Optional)
                                <span class="text-xs text-gray-500 ml-2 image-link-help">
                                    (e.g., Right-click image -> Copy Image Address. Example: https://placehold.co/600x400/101010/808080?text=Image)
                                </span>
                            </label>
                            <input type="url" id="image-url" class="w-full p-3 input-bg rounded-md" placeholder="e.g., https://example.com/your-game-screenshot.png">
                        </div>

                        <div id="custom-youtube-text-section" class="hidden">
                            <label for="custom-youtube-link-text" class="block mb-2 font-semibold text-gray-300">
                                Custom YouTube Link Text (Max 55 chars)
                            </label>
                            <input type="text" id="custom-youtube-link-text" class="w-full p-3 input-bg rounded-md" placeholder="e.g., Watch Trailer" maxlength="55">
                            <p id="custom-text-char-count" class="text-sm text-gray-400 mt-1 text-right">0/55</p>
                        </div>
                        <!-- End Media Selection Section -->

                        <div id="linked-game-promo-section" class="hidden">
                            <label for="linked-game-promo" class="block mb-2 font-semibold text-gray-300">Link to one of your Game Promotions (Required for Devlogs)</label>
                            <div class="custom-select">
                                <select id="linked-game-promo" class="w-full p-3 input-bg rounded-md">
                                    <option value="">Select one of your Game Promos</option>
                                    ${myGamePromoPosts.map(game => `<option value="${game.id}">${game.title}</option>`).join('')}
                                </select>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">If selected, clicking this Devlog will open the linked Game Promotion card.</p>
                        </div>

                        <div>
                            <label for="tags" class="block mb-2 font-semibold text-gray-300">
                                Tags (Optional, comma-separated)
                                <span class="text-xs text-gray-500 ml-2">
                                    (e.g., action, indie, pixel art)
                                </span>
                            </label>
                            <input type="text" id="tags" class="w-full p-3 input-bg rounded-md" placeholder="e.g., adventure, puzzle, 2d">
                        </div>

                        <div id="genre-section">
                            <label class="block mb-2 font-semibold text-gray-300">Genre (select at least 3 for Game Promotion)</label>
                            <input type="text" id="genre-search" class="w-full p-3 input-bg rounded-md mb-3" placeholder="Search genres...">
                            <p id="genre-search-status" class="text-sm text-gray-400 mb-3 hidden"></p>
                            <div id="genre-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 grid-checkbox-uniform">
                                <!-- Genres will be dynamically inserted here -->
                            </div>
                        </div>
                        <div id="platform-section">
                            <label class="block mb-2 font-semibold text-gray-300">Platform (select at least 1 for Game Promotion)</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 grid-checkbox-uniform">
                                ${platforms.map(p => `<label class="custom-checkbox"><input type="checkbox" name="platform" value="${p}"><span>${p}</span></label>`).join('')}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="pricing-section">
                            <div>
                                <label for="pricing" class="block mb-2 font-semibold text-gray-300">Pricing Model</label>
                                <div class="custom-select">
                                    <select id="pricing" class="w-full p-3 input-bg rounded-md" required>
                                        <option value="Free">Free</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Key Available">Key Available</option>
                                        <option value="On Promo">On Promo</option>
                                    </select>
                                </div>
                            </div>
                            <div id="comments-status-section">
                                <label class="block mb-2 font-semibold text-gray-300">Allow Comments?</label>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <label class="custom-checkbox">
                                        <input type="radio" name="allow-comments" value="true" checked required>
                                        <span>Yes</span>
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="radio" name="allow-comments" value="false" required>
                                        <span>No</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="made-with" class="block mb-2 font-semibold text-gray-300">Made With (e.g., Unity, Godot, Python) (Optional)</label>
                            <input type="text" id="made-with" class="w-full p-3 input-bg rounded-md" placeholder="e.g., Unity, C#, Blender">
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Does this game contain AI generated content?</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="ai-content" value="Yes" required>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="ai-content" value="No" required>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="general" class="block mb-2 font-semibold text-gray-300">General Info (Optional)</label>
                            <textarea id="general" rows="3" class="w-full p-3 input-bg rounded-md"></textarea>
                        </div>
                        <div>
                            <label for="reason" class="block mb-2 font-semibold text-gray-300">Why are you posting here? (Optional)</label>
                            <textarea id="reason" rows="3" class="w-full p-3 input-bg rounded-md"></textarea>
                        </div>
                        <button type="submit" id="submit-post-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-md text-lg">${editingPostId ? 'Update Post' : 'Submit Post'}</button>
                    </form>
                </div>
            `;
            // Event listeners are attached to the form and its elements within the targetElement
            const form = targetElement.querySelector('#post-form');
            if (form) {
                const descriptionInput = form.querySelector('#description');
                const descriptionPreview = form.querySelector('#description-preview');
                const charCount = form.querySelector('#char-count');

                // Function to update the live preview
                function updatePreview() {
                    const markdownText = descriptionInput.value;
                    descriptionPreview.innerHTML = convertMarkdownToHtml(markdownText);
                }

                // Function to apply formatting
                function applyFormat(formatType) {
                    const start = descriptionInput.selectionStart;
                    const end = descriptionInput.selectionEnd;
                    const currentValue = descriptionInput.value;
                    const selectedText = currentValue.substring(start, end);
                    let newText = '';
                    let newCursorPos = start; // Default cursor position

                    switch (formatType) {
                        case 'bold':
                            newText = `**${selectedText}**`;
                            newCursorPos = start + 2 + selectedText.length; // Cursor after selected text and closing **
                            break;
                        case 'italic':
                            newText = `*${selectedText}*`;
                            newCursorPos = start + 1 + selectedText.length; // Cursor after selected text and closing *
                            break;
                        case 'link':
                            // Store references to the current description input and selection
                            descriptionInputForLink = descriptionInput; 
                            linkSelectionStart = start;
                            linkSelectionEnd = end;
                            openLinkModal(start, end); // Open link modal
                            return; // Don't update description yet, it's handled by link modal
                        case 'bullet':
                            if (selectedText) {
                                newText = selectedText.split('\n').map(line => `- ${line}`).join('\n');
                                newCursorPos = start + (selectedText.split('\n')[0].length > 0 ? 2 : 0); // Cursor after '- ' for the first line
                            } else {
                                newText = '- ';
                                newCursorPos = start + 2; // Cursor after '- '
                            }
                            break;
                        case 'inline-code':
                            newText = `\`${selectedText}\``;
                            newCursorPos = start + 1 + selectedText.length; // Cursor after selected text and closing `
                            break;
                        case 'blockquote':
                            if (selectedText) {
                                newText = selectedText.split('\n').map(line => `> ${line}`).join('\n');
                                newCursorPos = start + (selectedText.split('\n')[0].length > 0 ? 2 : 0); // Cursor after '> ' for the first line
                            } else {
                                newText = '> ';
                                newCursorPos = start + 2; // Cursor after '> '
                            }
                            break;
                        case 'hr':
                            newText = '\n---\n';
                            newCursorPos = start + newText.length; // Cursor after the HR
                            break;
                        default:
                            return;
                    }

                    descriptionInput.value = currentValue.substring(0, start) + newText + currentValue.substring(end);
                    descriptionInput.selectionStart = descriptionInput.selectionEnd = newCursorPos; // Set cursor
                    descriptionInput.focus();
                    updatePreview();
                    const visibleLength = getVisibleCharCount(descriptionInput.value);
                    charCount.textContent = `${visibleLength}/1000`;
                }


                form.addEventListener('submit', handlePostSubmit);
                descriptionInput.addEventListener('input', e => {
                    const visibleLength = getVisibleCharCount(e.target.value);
                    charCount.textContent = `${visibleLength}/1000`;
                    updatePreview(); // Live update preview
                });

                // Attach event listeners to formatting buttons
                form.querySelectorAll('.formatting-toolbar-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault(); // Prevent form submission
                        const formatType = e.currentTarget.dataset.format;
                        applyFormat(formatType);
                    });
                });


                const mediaTypeRadios = form.querySelectorAll('input[name="media-type"]');
                const customYoutubeLinkTextInput = form.querySelector('#custom-youtube-link-text');
                const customTextCharCount = form.querySelector('#custom-text-char-count');

                if (customYoutubeLinkTextInput) {
                    customYoutubeLinkTextInput.addEventListener('input', e => {
                        customTextCharCount.textContent = `${e.target.value.length}/55`;
                    });
                }

                const postTypeSelect = form.querySelector('#post-type');
                const devlogTypeSelect = form.querySelector('#devlog-type');
                const genreSearchInput = form.querySelector('#genre-search');
                const genreCheckboxesContainer = form.querySelector('#genre-checkboxes');
                // const genreSearchStatus = form.querySelector('#genre-search-status'); // Removed local declaration as it's now accessed globally

                // Initial render of all genres
                renderGenreCheckboxes(genreCheckboxesContainer, genreSearchInput.value); // Pass container to the global function

                // Event delegation for genre checkboxes to update selectedGenres array
                genreCheckboxesContainer.addEventListener('change', (e) => {
                    if (e.target.name === 'genre') {
                        if (e.target.checked) {
                            if (!selectedGenres.includes(e.target.value)) {
                                selectedGenres.push(e.target.value);
                            }
                        } else {
                            selectedGenres = selectedGenres.filter(g => g !== e.target.value);
                        }
                    }
                });

                // Poll option management
                const pollOptionsContainer = form.querySelector('#poll-options-container');
                const addPollOptionBtn = form.querySelector('#add-poll-option-btn');

                function updateRemovePollOptionButtons(currentForm) {
                    const removeButtons = currentForm.querySelectorAll('.remove-poll-option-btn');
                    if (removeButtons.length <= 2) {
                        removeButtons.forEach(btn => btn.classList.add('hidden'));
                    } else {
                        removeButtons.forEach(btn => btn.classList.remove('hidden'));
                    }
                    if (removeButtons.length >= 5) {
                        addPollOptionBtn.disabled = true;
                        addPollOptionBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        addPollOptionBtn.disabled = false;
                        addPollOptionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                addPollOptionBtn.addEventListener('click', () => {
                    const currentOptions = pollOptionsContainer.querySelectorAll('.poll-option-input').length;
                    if (currentOptions < 5) {
                        const newOptionDiv = document.createElement('div');
                        newOptionDiv.className = 'flex gap-2';
                        newOptionDiv.innerHTML = `
                            <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option ${currentOptions + 1}" required>
                            <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md"><i class="fas fa-minus"></i></button>
                        `;
                        pollOptionsContainer.appendChild(newOptionDiv);
                        updateRemovePollOptionButtons(form); // Pass form reference
                    }
                });

                pollOptionsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-poll-option-btn') || e.target.closest('.remove-poll-option-btn')) {
                        const btn = e.target.closest('.remove-poll-option-btn');
                        btn.parentElement.remove();
                        updateRemovePollOptionButtons(form); // Pass form reference
                    }
                });

                mediaTypeRadios.forEach(radio => radio.addEventListener('change', () => toggleMediaSections(form)));
                postTypeSelect.addEventListener('change', () => togglePostTypeFields(form));
                devlogTypeSelect?.addEventListener('change', () => togglePostTypeFields(form));
                form.querySelectorAll('input[name="add-game-promo-poll"]').forEach(radio => radio.addEventListener('change', () => togglePostTypeFields(form)));

                // Only initialize visibility if not in editing mode (i.e., for new posts)
                if (!editingPostId) {
                    toggleMediaSections(form);
                    togglePostTypeFields(form);
                    selectedGenres = []; // Clear genres for new post
                    renderGenreCheckboxes(genreCheckboxesContainer); // Re-render to clear checkboxes
                } else {
                    // If in editing mode, ensure preview is updated with existing description
                    updatePreview();
                }

                // Genre search functionality
                genreSearchInput.addEventListener('input', (e) => {
                    renderGenreCheckboxes(genreCheckboxesContainer, e.target.value); // Pass container
                });
            }
        }

        // Opens the post modal and pre-fills it for editing.
        async function openEditModal(postId) {
            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post) {
                showAlert("Post not found for editing!");
                return;
            }

            editingPostId = postId; // Set the global editingPostId

            // Render the post page form into the modal content area
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button id="close-modal-btn" class="modal-action-btn"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex gap-2">
                        <button id="share-post-btn" class="modal-action-btn" data-post-id="${postId}"><i class="fa-solid fa-share"></i></button>
                        <button id="fullscreen-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div id="edit-form-container"></div>
            `;
            postModal.classList.remove('hidden'); // Show the modal
            updateBodyScrollLock(); // Ensure body scroll is locked
            updateDocumentTitle(`Edit Post: ${post.title}`); // Update title for edit modal
            document.getElementById('close-modal-btn').addEventListener('click', closePostModal);
            document.getElementById('fullscreen-toggle-btn').addEventListener('click', () => toggleFullscreen(modalContent)); // Add listener for fullscreen toggle
            
            // Before rendering, set selectedGenres from the post being edited
            selectedGenres = post.genres || []; 
            
            // Render the form directly into the edit-form-container
            const editFormContainer = document.getElementById('edit-form-container');
            renderPostPage(editFormContainer);
            
            // Now, populate the form fields
            // IMPORTANT: Query the form from within the modal's container to ensure correct reference
            const form = editFormContainer.querySelector('#post-form'); 
            
            if (form) { // Ensure form is found before attempting to populate
                form.querySelector('#game-title').value = post.title || '';
                form.querySelector('#description').value = post.description || '';
                // Update this line to use getVisibleCharCount
                const initialVisibleLength = getVisibleCharCount(post.description || '');
                form.querySelector('#char-count').textContent = `${initialVisibleLength}/1000`; // Use form.querySelector
                form.querySelector('#itch-link').value = post.itchLink || '';
                form.querySelector('#made-with').value = post.madeWith || '';
                form.querySelector('#general').value = post.general || '';
                form.querySelector('#reason').value = post.reason || '';
                form.querySelector('#tags').value = post.tags?.join(', ') || ''; // Populate tags field

                // Set Post Type and disable it
                const postTypeSelect = form.querySelector('#post-type');
                postTypeSelect.value = post.postType || 'Game Promotion';
                postTypeSelect.disabled = true; // Disable post type selection during edit

                // Set Devlog Type if applicable
                const devlogTypeSelect = form.querySelector('#devlog-type');
                if (post.postType === 'Devlog' && post.devlogType) {
                    devlogTypeSelect.value = post.devlogType;
                }

                // Populate poll fields if devlogType is 'Poll' or if it's a Game Promotion with a poll
                const addGamePromoPollRadios = form.querySelectorAll('input[name="add-game-promo-poll"]');
                const pollSection = form.querySelector('#poll-section');

                if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || 
                    (post.postType === 'Game Promotion' && post.poll)) { // Check for poll in Game Promotion
                    
                    // Disable poll fields if a poll already exists
                    if (pollSection) {
                        pollSection.classList.remove('hidden'); // Ensure poll section is visible
                        pollSection.querySelectorAll('input, button').forEach(element => {
                            element.disabled = true;
                            element.classList.add('opacity-50', 'cursor-not-allowed');
                        });
                        // Add a message indicating poll cannot be edited
                        const pollMessage = document.createElement('p');
                        pollMessage.className = 'text-sm text-red-600 mb-4 poll-edit-message'; // Added class for easier removal
                        pollMessage.textContent = 'This post already has a poll. Polls cannot be modified or deleted after creation.';
                        pollSection.prepend(pollMessage);
                    }

                    form.querySelector('#poll-question').value = post.poll.question || '';
                    const pollOptionsContainer = form.querySelector('#poll-options-container');
                    pollOptionsContainer.innerHTML = ''; // Clear existing options
                    post.poll.options.forEach((option, index) => {
                        const newOptionDiv = document.createElement('div');
                        newOptionDiv.className = 'flex gap-2';
                        newOptionDiv.innerHTML = `
                            <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option ${index + 1}" value="${option.text}" required disabled>
                            <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden" disabled><i class="fas fa-minus"></i></button>
                        `;
                        pollOptionsContainer.appendChild(newOptionDiv);
                    });
                    // Set 'Yes' for 'Add Poll' toggle if it's a Game Promotion with a poll
                    if (post.postType === 'Game Promotion' && post.poll) {
                        form.querySelector('input[name="add-game-promo-poll"][value="true"]').checked = true;
                        // Disable the radio buttons for poll toggle
                        addGamePromoPollRadios.forEach(radio => {
                            radio.disabled = true;
                            radio.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
                        });
                    }
                } else if (post.postType === 'Game Promotion') { // Ensure 'No' is selected if it's a Game Promo without a poll
                    form.querySelector('input[name="add-game-promo-poll"][value="false"]').checked = true;
                }


                // Set Media Type and links
                if (post.mediaType) {
                    const mediaRadio = form.querySelector(`input[name="media-type"][value="${post.mediaType}"]`);
                    if (mediaRadio) mediaRadio.checked = true;
                }
                form.querySelector('#trailer-link').value = post.trailerLink || '';
                form.querySelector('#image-url').value = post.imageUrl || '';
                form.querySelector('#custom-youtube-link-text').value = post.customYoutubeLinkText || ''; // Populate custom text field
                const customYoutubeLinkTextInput = form.querySelector('#custom-youtube-link-text');
                const customTextCharCount = form.querySelector('#custom-text-char-count');
                if (customYoutubeLinkTextInput && customTextCharCount) {
                    customTextCharCount.textContent = `${customYoutubeLinkTextInput.value.length}/55`;
                }

                // Set Pricing (only if Game Promotion)
                if (post.postType === 'Game Promotion' && post.pricing) {
                    form.querySelector('#pricing').value = post.pricing;
                }

                // Set AI Content
                if (post.aiContent) {
                    const aiRadio = form.querySelector(`input[name="ai-content"][value="${post.aiContent}"]`);
                    if (aiRadio) aiRadio.checked = true;
                }

                // Set Platforms
                if (post.platforms && post.platforms.length > 0) {
                    form.querySelectorAll('input[name="platform"]').forEach(checkbox => {
                        checkbox.checked = post.platforms.includes(checkbox.value);
                    });
                }

                // Set Comments Allowed
                if (post.allowComments !== undefined) {
                    const commentsRadio = form.querySelector(`input[name="allow-comments"][value="${post.allowComments}"]`);
                    if (commentsRadio) commentsRadio.checked = true;
                }

                // Set Linked Game Promo (only if Devlog)
                if (post.postType === 'Devlog' && post.linkedGamePromoId) {
                    form.querySelector('#linked-game-promo').value = post.linkedGamePromoId;
                }

                // Re-run toggle functions to ensure correct visibility based on pre-filled data
                // Pass the form and the post object to the global functions
                toggleMediaSections(form);
                togglePostTypeFields(form, post); // Pass the post object

                // Update submit button text
                form.querySelector('#submit-post-btn').textContent = 'Update Post'; // Use form.querySelector
                
                // Add event listener for share button
                document.getElementById('share-post-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent modal from closing if share button is clicked
                    const shareLink = `https://postitchindie.github.io/?postId=${postId}`;
                    copyToClipboard(shareLink);
                    showAlert("Link copied to clipboard!");
                });

                // Re-render genre checkboxes to reflect selected genres from the post
                const genreSearchInput = form.querySelector('#genre-search');
                const genreCheckboxesContainerInModal = form.querySelector('#genre-checkboxes');
                renderGenreCheckboxes(genreCheckboxesContainerInModal, genreSearchInput.value);
            } else {
                console.error("Form element not found in modal after rendering.");
            }
        }
        
        // Renders the search page.
        function renderSearchPage() {
            contentSearch.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6"> <!-- Adjusted max-width and padding for consistency -->
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Search for Games & Devlogs</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="search-input" class="w-full p-3 input-bg rounded-md" placeholder="Search by title, genre, platform, tags...">
                        <button id="search-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-md">Search</button>
                        <button id="random-game-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-dice"></i> Random
                        </button>
                    </div>
                    <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="col-span-full text-center text-gray-400">Please enter a search term.</p>
                    </div>
                </div>
            `;
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');

            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            // New: Add event listener for the Random Game button
            document.getElementById('random-game-btn').addEventListener('click', handleRandomGame);

            // Check URL for search query on page load
            const urlParams = new URLSearchParams(window.location.search);
            const searchQueryFromUrl = urlParams.get('query');
            if (searchQueryFromUrl) {
                searchInput.value = searchQueryFromUrl;
                handleSearch(); // Execute search if query param exists
            }
        }

        // Handles searching for posts based on a query term.
        function handleSearch() {
            const searchInput = document.getElementById('search-input');
            const queryTerm = searchInput.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results');
            
            // Update URL with search query
            const url = new URL(window.location.href);
            if (queryTerm) {
                url.searchParams.set('query', queryTerm);
            } else {
                url.searchParams.delete('query');
            }
            url.searchParams.set('section', 'search'); // Ensure section is 'search'
            window.history.replaceState({}, '', url.toString());

            if (!queryTerm) {
                resultsContainer.innerHTML = '<p class="col-span-full text-center text-gray-400">Please enter a search term.</p>';
                return;
            }
            // Filter posts based on title, description, genres, platforms, or tags
            const results = allFetchedPosts.filter(post => // Use allFetchedPosts
                post.title.toLowerCase().includes(queryTerm) ||
                stripMarkdown(post.description).toLowerCase().includes(queryTerm) || // Search stripped description
                (post.genres && post.genres.some(g => g.toLowerCase().includes(queryTerm))) || // Check if genres exist
                (post.platforms && post.platforms.some(p => p.toLowerCase().includes(queryTerm))) || // Check if platforms exist
                (post.madeWith && post.madeWith.toLowerCase().includes(queryTerm)) || // Search 'madeWith' field
                (post.tags && post.tags.some(t => t.toLowerCase().includes(queryTerm))) || // Search 'tags' field
                (post.aiContent && post.aiContent.toLowerCase().includes(queryTerm)) || // Search 'aiContent' field
                (post.devlogType && post.devlogType.toLowerCase().includes(queryTerm)) // Search 'devlogType' field
            );
            
            if (results.length > 0) {
                resultsContainer.innerHTML = results.map(post => renderPostCard(post, false)).join(''); // Pass false for isMyPostPage
                addCardEventListeners(); // Re-attach event listeners to new cards
            } else {
                resultsContainer.innerHTML = '<p class="col-span-full text-center text-gray-400">No games or devlogs found matching your search.</p>';
            }
        }

        // Handles opening a random game's detailed modal.
        async function handleRandomGame() {
            const gamePromotions = allFetchedPosts.filter(p => p.postType === 'Game Promotion');
            if (gamePromotions.length === 0) {
                showAlert("No game promotions available to pick a random game from.");
                return;
            }

            const randomIndex = Math.floor(Math.random() * gamePromotions.length);
            const randomGame = gamePromotions[randomIndex];

            if (randomGame) {
                await openPostModal(randomGame.id, false, true); // Open random game modal, increment view
            } else {
                showAlert("Could not find a random game. Please try again.");
            }
        }

        // Renders the user's own posts page.
        function renderMyPostsPage() {
            const myPosts = allFetchedPosts.filter(p => p.authorId === currentUser?.uid);
            renderPostsGrid(contentMyPosts, myPosts, "My Posts", true, true, true, true); // My Posts will also have sort, pricing, and AI content filter, and edit/delete enabled
        }

		// Renders the About page content.
		function renderAboutPage() {
			contentAbout.innerHTML = `
				<div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg text-center">
					<h2 class="text-3xl sm:text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">About PostItch</h2>
					<p class="text-base sm:text-lg text-gray-300 mb-6">
						PostItch is a dedicated platform built for indie game developers to anonymously share and showcase their creations from <a href="https://itch.io" target="_blank" class="underline text-cyan-400 hover:text-cyan-300">itch.io</a>. Whether you're sharing a prototype, demo, or fully released game, PostItch creates a welcoming space where creators and players can interact without judgment or pressure.
					</p>
					<p class="text-base sm:text-lg text-gray-300 mb-6">
						Our goal is to spark discovery, inspiration, and connection in the indie dev community. Players can explore a curated feed of hidden gems, while developers can gain visibility and feedback without revealing personal details or dealing with social media stress.
					</p>
					<p class="text-gray-400 text-sm sm:text-base mb-6">
						Built with love for the indie scene, PostItch is completely free and privacy-first. Your creativity matters here. Share what you love, get inspired, and join a movement that values honesty, experimentation, and play.
					</p>
					<p class="text-gray-500 text-xs sm:text-sm mt-8">
						Made by <a href="https://fillabrona.itch.io/" target="_blank" class="text-blue-400 underline hover:text-blue-300">Fillabrona</a>
					</p>
                    <div class="mt-8 pt-6 border-t border-gray-700 flex flex-col sm:flex-row justify-center gap-4">
                        <button id="share-website-btn" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fa-solid fa-share mr-2"></i> Share PostItch
                        </button>
                        <a href="https://postitchguide.github.io/" target="_blank" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-book mr-2"></i> PostItch Guide
                        </a>
                        <button id="open-settings-from-about" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-cog mr-2"></i> Open Settings
                        </button>
                    </div>
                    <!-- AI Assistant Button -->
                    <div class="mt-4 flex justify-center">
                        <button id="open-ai-assistant-btn" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fa-solid fa-brain mr-2"></i> AI Assistant for Help
                        </button>
                    </div>
				</div>
			`;
            document.getElementById('open-settings-from-about').addEventListener('click', () => {
                switchTab('settings');
            });
            // Event listener for "Share Website" button
            document.getElementById('share-website-btn').addEventListener('click', () => {
                const websiteLink = "https://postitchindie.github.io/?section=community";
                copyToClipboard(websiteLink);
                showAlert("Website link copied to clipboard!");
            });
            // Event listener for "AI Assistant" button
            document.getElementById('open-ai-assistant-btn').addEventListener('click', openAiAssistantModal);
		}
        
        // Renders the Community Rules page content.
        function renderRulesPage() {
            contentRules.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">Community Rules</h2>
                    <ul class="space-y-4">
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Be Respectful:</strong> Treat everyone with kindness. Harassment, hate speech, or personal attacks will not be tolerated.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Relevant Content Only:</strong> All posts must relate to a game on itch.io. Off-topic content will be removed.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Valid Links:</strong> Ensure your itch.io and YouTube links are functional and direct to the correct content.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>No Spamming:</strong> Do not post the same game repeatedly within a short timeframe (e.g., 7 days). Devlogs are welcome for updates.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Honest Representation:</strong> Be truthful about your game's features, genre, platform, and pricing.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Anonymity is Key:</strong> This platform uses anonymous sign-in. Do not attempt to de-anonymize others or share personal information.</span></li>
                    </ul>
                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-2xl font-bold mb-4 text-gray-500">Content Quality Guidelines</h3>
                        <ul class="space-y-4 text-gray-300">
                            <li class="flex items-start"><i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i><span><strong>Image Quality:</strong> Thumbnails and images must be clear, high quality, and directly related to the game. Blurry, stretched, low-effort, or unrelated visuals may lead to your post being removed or modified. Avoid random text-heavy or poorly designed thumbnails—only clean, appealing images are allowed.</span></li>
                            <li class="flex items-start"><i class="fas fa-robot text-red-400 mt-1 mr-3"></i><span><strong> AI Generated Content:</strong> AI-generated images that are low quality or visually unappealing will be removed. Visually appealing AI-generated content is allowed but must be clearly labeled as AI-generated. Any AI content that is misleading or lacks proper disclosure may be subject to removal.</span></li>
                            <li class="flex items-start"><i class="fas fa-align-left text-blue-400 mt-1 mr-3"></i><span><strong>Description & Marketing:</strong> Posts must have good descriptions, positive energy, and effective marketing. Bad descriptions, negative energy, bad language, horrible marketing, or false advertising will result in your post being deleted or modified.</span></li>
                            <li class="flex items-start"><i class="fas fa-star-half-alt text-purple-400 mt-1 mr-3"></i><span><strong>Post Performance:</strong> All posts that perform exceptionally well (e.g., gain significant traction, high ratings, or large number of downloads) on Itch.io itself, may be deleted from PostItch. This policy aims to provide a better discovery experience for users seeking new games and offers better visibility for emerging developers on our platform.</span></li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Renders the Settings page content.
        function renderSettingsPage() {
            contentSettings.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Theme Preference</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="system" ${userSettings.theme === 'system' ? 'checked' : ''}>
                                    <span>System Preference</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="dark" ${userSettings.theme === 'dark' ? 'checked' : ''}>
                                    <span>Dark Mode</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="light" ${userSettings.theme === 'light' ? 'checked' : ''}>
                                    <span>Light Mode</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Text Size</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="sm" ${userSettings.textSize === 'sm' ? 'checked' : ''}>
                                    <span>Small</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="base" ${userSettings.textSize === 'base' ? 'checked' : ''}>
                                    <span>Medium</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="lg" ${userSettings.textSize === 'lg' ? 'checked' : ''}>
                                    <span>Large</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Animations</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="animations" value="true" ${userSettings.animations ? 'checked' : ''}>
                                    <span>On</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="animations" value="false" ${!userSettings.animations ? 'checked' : ''}>
                                    <span>Off</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Show Post Counts (Likes, Comments, Views, Visits)</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="show-post-counts" value="true" ${userSettings.showPostCounts ? 'checked' : ''}>
                                    <span>On</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="show-post-counts" value="false" ${!userSettings.showPostCounts ? 'checked' : ''}>
                                    <span>Off</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Default Post Type</label>
                            <div class="custom-select">
                                <select id="default-post-type" class="w-full p-3 input-bg rounded-md">
                                    <option value="Game Promotion" ${userSettings.defaultPostType === 'Game Promotion' ? 'selected' : ''}>Game Promotion</option>
                                    <option value="Devlog" ${userSettings.defaultPostType === 'Devlog' ? 'selected' : ''}>Devlog</option>
                                </select>
                            </div>
                        </div>

                        <!-- Removed Default Feed Sort Order setting as per request -->

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Default Post Count Display</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="default-post-count-display" value="exact" ${userSettings.defaultPostCountDisplay === 'exact' ? 'checked' : ''}>
                                    <span>Exact Numbers (e.g., 1250)</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="default-post-count-display" value="abbreviated" ${userSettings.defaultPostCountDisplay === 'abbreviated' ? 'checked' : ''}>
                                    <span>Abbreviated (e.g., 1.3k)</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Automatically Open Modals Fullscreen</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="modal-fullscreen-setting" value="true" ${userSettings.modalFullscreen ? 'checked' : ''}>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="modal-fullscreen-setting" value="false" ${!userSettings.modalFullscreen ? 'checked' : ''}>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Always Mute Videos When Opened</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="always-mute-videos" value="true" ${userSettings.alwaysMuteVideos ? 'checked' : ''}>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="always-mute-videos" value="false" ${!userSettings.alwaysMuteVideos ? 'checked' : ''}>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-gray-700 space-y-4">
                            <h3 class="text-xl font-bold text-red-600">Danger Zone</h3>
                            <button id="delete-all-posts-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md w-full flex items-center justify-center gap-2 transition-all duration-300">
                                <i class="fas fa-trash mr-2"></i> Delete All My Posts
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Fix for theme preference listener
            contentSettings.querySelectorAll('input[name="theme-preference"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.theme = e.target.value;
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="text-size"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.textSize = e.target.value;
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="animations"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.animations = e.target.value === 'true';
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="show-post-counts"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.showPostCounts = e.target.value === 'true';
                    applySettings(); // Re-apply to update card rendering
                    saveUserSettings();
                });
            });

            contentSettings.querySelector('#default-post-type').addEventListener('change', (e) => {
                userSettings.defaultPostType = e.target.value;
                saveUserSettings();
            });

            // Removed event listener for default-sort-order as the setting is removed.

            contentSettings.querySelectorAll('input[name="default-post-count-display"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.defaultPostCountDisplay = e.target.value;
                    applySettings(); // Re-apply to update post count display on feeds
                    saveUserSettings();
                });
            });

            // New: Event listener for modal fullscreen setting
            contentSettings.querySelectorAll('input[name="modal-fullscreen-setting"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.modalFullscreen = e.target.value === 'true';
                    saveUserSettings();
                });
            });

            // New: Event listener for always mute videos setting
            contentSettings.querySelectorAll('input[name="always-mute-videos"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.alwaysMuteVideos = e.target.value === 'true';
                    saveUserSettings();
                });
            });

            // Event listener for "Delete All My Posts" button
            document.getElementById('delete-all-posts-btn').addEventListener('click', async () => {
                if (!currentUser || !isAuthReady) {
                    showAlert("Please wait for authentication to complete before deleting posts.");
                    return;
                }

                const confirmStep1 = await showConfirm("Are you absolutely sure you want to delete ALL your posts? This action cannot be undone. Click 'Yes' to proceed.");
                if (!confirmStep1) {
                    return;
                }

                const confirmationText = "I want to delete all my posts from PostItch";
                const userConfirmedInput = await showConfirmWithInput(
                    "This is your final warning: ALL your posts will be permanently deleted. There is NO UNDO.",
                    confirmationText
                );
                
                if (userConfirmedInput) { // If the user typed the correct phrase and clicked confirm
                    try {
                        const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                        const q = query(postsRef, where("authorId", "==", currentUser.uid));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            showAlert("You have no posts to delete.");
                            return;
                        }

                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showAlert("All your posts have been successfully deleted.").then(() => {
                            switchTab('community'); // Navigate to community page after deletion
                        });
                    } catch (error) {
                        console.error("Error deleting all posts:", error);
                        showAlert(`Failed to delete all posts: ${error.message || error}. Please check your browser console.`);
                    }
                } else {
                    showAlert("Deletion cancelled or incorrect confirmation text.");
                }
            });
        }
        
        // This function now uses onSnapshot to keep 'allFetchedPosts' array updated in real-time.
        function listenForPostsRealtime() {
            const postsColRef = collection(db, `artifacts/${appId}/public/data/posts`);
            // Use onSnapshot to get real-time updates for ALL posts
            onSnapshot(postsColRef, (snapshot) => {
                allFetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Ensure posts are sorted by creation date by default for initial display, then apply current sort preference
                allFetchedPosts.sort((a, b) => {
                    // Handle cases where createdAt might be missing or not a Timestamp object
                    // Ensure createdAt is treated as a Date object for comparison
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA; // Newest first
                });

                // Re-render the currently active tab to reflect the updated data
                const activeTab = document.querySelector('.nav-item.active')?.getAttribute('data-tab') || 'community';
                if (activeTab === 'community') {
                    renderCommunityPage(); // Re-render community page with potentially new/updated posts
                } else if (activeTab === 'my-posts') {
                    renderMyPostsPage(); // Re-render my posts page
                } else if (activeTab === 'promos') {
                    renderPromosPage();
                } else if (activeTab === 'devlogs') {
                    renderDevlogsPage();
                } else if (activeTab === 'search') {
                    // Re-run search if on search tab to update results based on new data
                    handleSearch();
                }
                // If the modal is open, re-render its content to reflect any changes (e.g., comment likes, poll votes)
                if (isPostModalOpen) {
                    const currentPostId = modalContent.querySelector('.modal-action-btn[data-post-id]')?.dataset.postId || editingPostId;
                    if (currentPostId) {
                        // Re-open the modal, but do NOT increment views again via this re-render
                        openPostModal(currentPostId, false, false); // Pass false for incrementView
                    }
                }
            }, error => {
                console.error("Error listening for posts:", error);
                showAlert(`Error fetching posts: ${error.message || error}. Please check your Firebase Security Rules.`);
            });
        }

        // Handles the submission of a new post to Firestore.
        async function handlePostSubmit(e) {
            e.preventDefault();
            const submitBtn = e.submitter; // Get the submit button that was clicked
            if (!submitBtn) return; // Should not happen with a form submit

            console.log("handlePostSubmit called. editingPostId:", editingPostId); // Added for debugging

            submitBtn.disabled = true; // Disable button
            submitBtn.textContent = 'Submitting...'; // Change text
            
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait for authentication to complete before posting. If this persists, refresh the page.");
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                return;
            }

            const form = e.target;
            const postType = form.querySelector('#post-type').value;
            // Get genres from the global selectedGenres array
            const genres = [...selectedGenres]; 
            const platforms = [...form.querySelectorAll('input[name="platform"]:checked')].map(el => el.value);
            const mediaType = form.querySelector('input[name="media-type"]:checked').value; // Get from form
            const aiContent = form.querySelector('input[name="ai-content"]:checked')?.value;
            const tagsInput = form.querySelector('#tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '') : [];
            const itchLink = form.querySelector('#itch-link').value.trim();
            const allowComments = form.querySelector('input[name="allow-comments"]:checked')?.value === 'true'; // Get comments setting
            const linkedGamePromoId = form.querySelector('#linked-game-promo')?.value || null; // Get linked game promo ID
            const devlogType = form.querySelector('#devlog-type')?.value || null; // Get devlog type
            const addGamePromoPoll = form.querySelector('input[name="add-game-promo-poll"]:checked')?.value === 'true'; // New: for Game Promo poll toggle

            // Poll data if devlogType is 'Poll' or if postType is 'Game Promotion' and addGamePromoPoll is true
            let pollData = null;
            const pollSection = form.querySelector('#poll-section');
            const pollQuestionInput = form.querySelector('#poll-question');
            const pollOptionInputs = form.querySelectorAll('.poll-option-input');

            // Check if poll section is visible and not disabled (meaning a new poll is being created)
            if (!pollSection.classList.contains('hidden') && !pollQuestionInput.disabled) {
                const pollQuestion = pollQuestionInput.value.trim();
                const pollOptions = [...pollOptionInputs].map(input => ({
                    text: input.value.trim(),
                    votes: 0 // Initialize votes to 0 for new polls
                }));

                if (!pollQuestion) {
                    showAlert("Poll question cannot be empty.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (pollOptions.length < 2 || pollOptions.length > 5 || pollOptions.some(opt => !opt.text)) {
                    showAlert("Please provide between 2 and 5 non-empty poll options.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                pollData = { question: pollQuestion, options: pollOptions, voters: [] }; // Initialize voters array for new polls
            }


            // Validation based on post type
            if (postType === 'Game Promotion') {
                if (genres.length < 3) {
                    showAlert("For Game Promotion, please select at least 3 genres.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (platforms.length < 1) {
                    showAlert("For Game Promotion, please select at least 1 platform.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // Itch.io link is required for Game Promotion
                if (!itchLink) {
                    showAlert("For Game Promotion, an Itch.io Link is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // No spamming rule for Game Promotion: check if the same itchLink was posted recently by the same user
                if (!editingPostId) { // Only apply for new posts
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const recentPost = allFetchedPosts.find(p => 
                        p.authorId === currentUser.uid && 
                        p.itchLink === itchLink && 
                        p.createdAt && p.createdAt.toDate() > sevenDaysAgo
                    );
                    if (recentPost) {
                        showAlert("You have already posted this game recently. Please wait at least 7 days before posting the same game again to avoid spamming.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Post';
                        return;
                    }
                }
            } else if (postType === 'Devlog') {
                // For Devlogs, a linked game promo is now required
                if (!linkedGamePromoId) {
                    showAlert("For Devlog, you must select one of your Game Promotions to link to.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // For Devlogs, if a game promo is linked, ensure it's a valid ID
                if (linkedGamePromoId) {
                    const linkedPostExists = allFetchedPosts.some(p => p.id === linkedGamePromoId && p.postType === 'Game Promotion' && p.authorId === currentUser.uid);
                    if (!linkedPostExists) {
                        showAlert("The selected linked game promotion is invalid or not one of your own.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                        return;
                    }
                }
                // Itch.io link is optional for Devlog, no validation needed here
            }

            // Validate AI Content field
            if (!aiContent) {
                showAlert("Please indicate if this game contains AI generated content.");
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                return;
            }

            let trailerLink = '';
            let imageUrl = '';
            let customYoutubeLinkText = '';

            if (mediaType === 'youtube' || mediaType === 'combo') {
                trailerLink = form.querySelector('#trailer-link').value.trim();
                // Combo requires YouTube link
                if (mediaType === 'combo' && !trailerLink) { 
                    showAlert("For Combo media type, the YouTube Trailer/Gameplay Link is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (trailerLink && !getYouTubeVideoId(trailerLink)) { // Use getYouTubeVideoId for validation
                    showAlert("Please enter a valid YouTube link (e.g., youtube.com/watch?v=... or youtu.be/...).");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            if (mediaType === 'image' || mediaType === 'combo') {
                imageUrl = form.querySelector('#image-url').value.trim();
                // Combo requires Image URL
                if (mediaType === 'combo' && !imageUrl) { 
                    showAlert("For Combo media type, the Image URL is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // Relaxed URL validation for image formats - any valid URL is accepted
                if (imageUrl && !imageUrl.match(/^https?:\/\/[^\s$.?#].[^\s]*$/i)) {
                    showAlert("Please enter a valid URL for the image link.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            // For combo, get the custom YouTube link text
            if (mediaType === 'combo') {
                customYoutubeLinkText = form.querySelector('#custom-youtube-link-text').value.trim();
                // Combo requires custom text
                if (!customYoutubeLinkText) {
                    showAlert("For Combo media type, Custom YouTube Link Text is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (customYoutubeLinkText.length > 55) {
                    showAlert("Custom YouTube Link Text cannot exceed 55 characters.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            // If mediaType is 'none' or 'itch_embed', trailerLink and imageUrl will remain empty, which is correct.

            const basePostData = {
                authorId: currentUser.uid,
                title: form.querySelector('#game-title').value.trim(),
                description: form.querySelector('#description').value.trim(),
                itchLink: itchLink,
                mediaType: mediaType, // Store selected media type
                trailerLink: trailerLink, // Store YouTube link if applicable
                imageUrl: imageUrl,       // Store image URL if applicable
                customYoutubeLinkText: customYoutubeLinkText, // Store custom YouTube link text
                postType: postType, // Use the selected post type
                madeWith: form.querySelector('#made-with').value.trim(), // New field
                aiContent: aiContent, // New required field
                tags: tags, // Store tags
                allowComments: allowComments, // Store comments setting
                general: form.querySelector('#general').value.trim(),
                reason: form.querySelector('#reason').value.trim(),
            };

            try {
                if (editingPostId) {
                    // Update existing post
                    const postRef = doc(db, `artifacts/${appId}/public/data/posts`, editingPostId);
                    const existingPost = allFetchedPosts.find(p => p.id === editingPostId);

                    if (!existingPost) {
                        showAlert("Error: Existing post not found for update.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Update Post';
                        return;
                    }

                    let updatePayload = {
                        ...basePostData, // Start with all common fields
                        // Preserve existing non-editable fields
                        likes: existingPost.likes || [],
                        comments: existingPost.comments || [],
                        views: existingPost.views || 0,
                        visits: existingPost.visits || 0,
                        createdAt: existingPost.createdAt, // Preserve original creation timestamp
                    };

                    // Handle poll specifically for updates
                    if (existingPost.poll) {
                        // If a poll already exists, it cannot be modified or deleted. Preserve it.
                        updatePayload.poll = existingPost.poll;
                    } else {
                        // If no poll exists on the original post
                        if ((postType === 'Devlog' && devlogType === 'Poll') || (postType === 'Game Promotion' && addGamePromoPoll)) {
                            // If a new poll is being added during this edit
                            updatePayload.poll = pollData;
                        } else {
                            // If no poll exists and no new poll is being added, explicitly delete it in case it was there before
                            updatePayload.poll = deleteField();
                        }
                    }

                    // Handle type-specific fields for updates
                    if (postType === 'Game Promotion') {
                        updatePayload.pricing = form.querySelector('#pricing').value;
                        updatePayload.genres = genres;
                        updatePayload.platforms = platforms;
                        // Ensure devlog-specific fields are removed if changing type
                        updatePayload.linkedGamePromoId = deleteField();
                        updatePayload.devlogType = deleteField();
                    } else if (postType === 'Devlog') {
                        updatePayload.linkedGamePromoId = linkedGamePromoId;
                        updatePayload.devlogType = devlogType;
                        // Ensure game promo-specific fields are removed if changing type
                        updatePayload.pricing = deleteField();
                        updatePayload.genres = deleteField();
                        updatePayload.platforms = deleteField();
                    }
                    
                    console.log("Constructed updatePayload:", updatePayload); // Added for debugging
                    await updateDoc(postRef, updatePayload, { merge: true }); // Use merge: true for deleteField
                    showAlert("Post updated successfully!").then(() => {
                        closePostModal(); // Close modal after update
                        displayLimit = postsPerPage; // Reset display limit for community page
                        switchTab('my-posts'); // Navigate back to my posts
                    });

                } else {
                    // Add new post
                    let newPostData = {
                        ...basePostData,
                        likes: [], // Initialize likes for new post
                        comments: [], // Initialize comments for new post
                        views: 0, // Initialize views for new post
                        visits: 0, // Initialize visits for new post
                        createdAt: serverTimestamp(), // Set timestamp for new post
                    };

                    // Add type-specific fields for new posts
                    if (postType === 'Game Promotion') {
                        newPostData.pricing = form.querySelector('#pricing').value;
                        newPostData.genres = genres;
                        newPostData.platforms = platforms;
                        if (addGamePromoPoll && pollData) {
                            newPostData.poll = pollData;
                        }
                    } else if (postType === 'Devlog') {
                        newPostData.linkedGamePromoId = linkedGamePromoId;
                        newPostData.devlogType = devlogType;
                        if (devlogType === 'Poll' && pollData) {
                            newPostData.poll = pollData;
                        }
                    }

                    await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), newPostData);
                    showAlert("Post submitted successfully!").then(() => {
                        form.reset(); // Clear form fields after successful submission
                        // Reset character count and media selection UI to default
                        form.querySelector('#char-count').textContent = `0/1000`; // Use form.querySelector
                        if (form.querySelector('#custom-text-char-count')) {
                            form.querySelector('#custom-text-char-count').textContent = `0/55`;
                        }
                        
                        // Set media-youtube radio and dispatch change event
                        const mediaYoutubeRadio = form.querySelector('#media-youtube');
                        if (mediaYoutubeRadio) {
                            mediaYoutubeRadio.checked = true;
                            mediaYoutubeRadio.dispatchEvent(new Event('change'));
                        }

                        // Reset post type fields visibility
                        const postTypeSelect = form.querySelector('#post-type');
                        postTypeSelect.value = userSettings.defaultPostType; // Reset to default from settings
                        // Re-run togglePostTypeFields to reset UI for Game Promotion
                        postTypeSelect.dispatchEvent(new Event('change'));
                        
                        // Clear selected genres after successful post submission
                        selectedGenres = [];
                        // Re-render genre checkboxes to clear selections visually
                        const genreCheckboxesContainer = form.querySelector('#genre-checkboxes');
                        renderGenreCheckboxes(genreCheckboxesContainer);
                        switchTab('my-posts'); // Navigate directly to my posts after new post
                    });
                }
            } catch (error) {
                console.error("Error handling post:", error);
                showAlert(`Failed to ${editingPostId ? 'update' : 'submit'} post: ${error.message || error}. This often happens due to incorrect Firebase Security Rules or network issues. Please check your browser console for more details.`);
            } finally {
                // Ensure the button is always re-enabled and text reset
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
            }
        }
        
        // Toggles a like on a post (adds or removes the current user's UID from the likes array).
        async function toggleLike(postId) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before liking.");
                return;
            }
            // Get the document reference using the correct Firestore path
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId); // Use allFetchedPosts
            if (!post) {
                console.error("Post not found for liking:", postId);
                showAlert("Could not like post: Post not found.");
                return;
            }

            let newLikes = post.likes || [];
            if (newLikes.includes(currentUser.uid)) {
                newLikes = newLikes.filter(uid => uid !== currentUser.uid); // Unlike
            } else {
                newLikes.push(currentUser.uid); // Like
            }
            try {
                await updateDoc(postRef, { likes: newLikes });
            } catch (error) {
                console.error("Error toggling like:", error);
                showAlert(`Failed to toggle like: ${error.message || error}.`);
            }
        }
        
        // --- MODAL LOGIC FOR INDIVIDUAL POST VIEW ---
        // Toggles fullscreen mode for a given modal element.
        // `forceState` (optional boolean): if true, forces fullscreen; if false, forces normal; if undefined, toggles.
        function toggleFullscreen(modalElement, forceState) {
            const isFullscreen = modalElement.classList.contains('fullscreen');
            const shouldBeFullscreen = (forceState !== undefined) ? forceState : !isFullscreen;

            const backdrop = modalElement.previousElementSibling; // Assuming backdrop is the immediate previous sibling

            if (shouldBeFullscreen) {
                modalElement.classList.add('fullscreen');
                if (backdrop) backdrop.classList.add('fullscreen');
                // The body scroll lock is now handled by updateBodyScrollLock(), no need to add here
                // document.body.classList.add('modal-fullscreen-active'); // Prevent body scrolling
                // Update button icon for the specific modal
                const toggleBtn = modalElement.id === 'modal-content' ? document.getElementById('fullscreen-toggle-btn') : document.getElementById('fullscreen-video-toggle-btn');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                modalElement.classList.remove('fullscreen');
                if (backdrop) backdrop.classList.remove('fullscreen');
                // The body scroll lock is now handled by updateBodyScrollLock(), no need to remove here
                // document.body.classList.remove('modal-fullscreen-active'); // Restore body scrolling
                // Update button icon for the specific modal
                const toggleBtn = modalElement.id === 'modal-content' ? document.getElementById('fullscreen-toggle-btn') : document.getElementById('fullscreen-video-toggle-btn');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
            updateBodyScrollLock(); // Ensure body scroll lock is updated after fullscreen toggle
        }

        // Opens a modal displaying detailed information about a selected post.
        async function openPostModal(postId, focusComment = false, incrementView = true, fromURL = false) { // Added fromURL parameter
            // Set flag to true immediately to prevent multiple modal instances
            isPostModalOpen = true; 

            const post = allFetchedPosts.find(p => p.id === postId); // Use allFetchedPosts
            if (!post) {
                showAlert("Post not found!");
                isPostModalOpen = false; // Reset flag if post not found
                return;
            }

            if (incrementView) { // Only increment view if explicitly requested (i.e., user clicked card)
                const currentTime = Date.now();
                const lastViewTime = lastViewTimestamps.get(postId);

                // Increment view count only if enough time has passed since the last view for this post
                if (!lastViewTime || (currentTime - lastViewTime > VIEW_COOLDOWN_MS)) {
                    try {
                        const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                        await updateDoc(postRef, { views: (post.views || 0) + 1 });
                        // Optimistically update the local data
                        post.views = (post.views || 0) + 1; // Update the local 'post' object immediately
                        lastViewTimestamps.set(postId, currentTime); // Record this view timestamp
                        console.log(`View for post ${postId} incremented. New views: ${post.views}`);
                    } catch (error) {
                        console.error("Error incrementing view count:", error);
                    }
                } else {
                    console.log(`View for post ${postId} not incremented due to cooldown. Last view: ${((currentTime - lastViewTime) / 1000).toFixed(1)}s ago.`);
                }
            }

            // Update URL when post modal is opened
            const url = new URL(window.location.href);
            url.searchParams.set('postId', postId);
            url.searchParams.delete('section'); // Remove section if a post is opened
            url.searchParams.delete('videoId'); // Remove videoId if present
            url.searchParams.delete('modal'); // Remove modal if present
            url.searchParams.delete('query'); // Remove search query if present
            window.history.pushState({}, '', url.toString());

            let mediaHtml = '';
            let modalYoutubeLinkHtml = ''; // New variable for combo link in modal
            // Dynamically render media content within the modal
            if (post.mediaType === 'youtube' && post.trailerLink) {
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    // For YouTube, directly embed the video in the modal
                    // If opened from URL, initially show thumbnail and play button
                    if (fromURL) {
                        const thumbnailUrl = getYouTubeThumbnailUrl(videoId);
                        mediaHtml = `
                            <div class="aspect-video w-full rounded-md overflow-hidden relative">
                                <img src="${thumbnailUrl}" alt="YouTube Thumbnail" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/800x450/101010/808080?text=Video+Not+Found';">
                                <div class="play-button-overlay" id="modal-youtube-play-button" data-video-id="${videoId}">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        // Otherwise, autoplay as before
                        const embedSrc = getYouTubeEmbedSrc(videoId, true); // Always autoplay in modal if not from URL
                        mediaHtml = `<div class="aspect-video w-full rounded-md overflow-hidden relative" id="modal-youtube-player-container">
                                        <iframe class="w-full h-full rounded-none" src="${embedSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                    </div>`;
                    }
                }
            } else if (post.mediaType === 'image' && post.imageUrl) {
                mediaHtml = `<div class="w-full h-auto max-h-96 flex justify-center items-center overflow-hidden rounded-md">
                                <img src="${post.imageUrl}" alt="${post.title}" class="max-w-full max-h-full object-contain rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/800x450/101010/808080?text=Image+Not+Found';">
                            </div>`;
            } else if (post.mediaType === 'combo' && post.trailerLink && post.imageUrl) {
                // For combo in modal, display the image and a separate clickable button
                mediaHtml = `<div class="w-full h-auto max-h-96 flex justify-center items-center overflow-hidden rounded-md mb-4">
                                <img src="${post.imageUrl}" alt="Custom Thumbnail" class="max-w-full max-h-full object-contain rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/800x450/101010/808080?text=Custom+Thumbnail+Not+Found';">
                            </div>`;
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    modalYoutubeLinkHtml = `
                        <div class="flex justify-center my-4">
                            <button id="open-video-player-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base" data-video-id="${videoId}">
                                <i class="fab fa-youtube"></i> ${post.customYoutubeLinkText || 'Watch Trailer'}
                            </button>
                        </div>
                    `;
                }
            } else if (post.mediaType === 'itch_embed' && post.itchLink) {
                mediaHtml = getItchEmbedHtml(post.itchLink); // Use the updated function for Itch.io
            }

            // Fallback if no valid media is available for the post (or mediaType is 'none')
            if (!mediaHtml || post.mediaType === 'none') {
                mediaHtml = `<div class="h-48 bg-[#101010] flex items-center justify-center text-gray-500 rounded-md"><i class="fas fa-image fa-4x"></i><p class="ml-4"></p></div>`;
            }

            // Render poll section if devlogType is 'Poll' or if postType is 'Game Promotion' and it has a poll
            let pollHtml = '';
            if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || (post.postType === 'Game Promotion' && post.poll)) {
                const totalVotes = post.poll.options.reduce((sum, option) => sum + (option.votes || 0), 0);
                pollHtml = `
                    <div class="mt-8 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">Poll: ${post.poll.question}</h3>
                        <div class="space-y-3">
                            ${post.poll.options.map((option, index) => {
                                const percentage = totalVotes > 0 ? ((option.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                                const hasVoted = post.poll.voters?.includes(currentUser?.uid);
                                return `
                                    <div class="bg-[#1a1a1a] p-3 rounded-md shadow-sm">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-gray-300 text-sm sm:text-base">${option.text}</span>
                                            <span class="text-gray-400 text-xs">${formatNumberForDisplay(option.votes || 0)} votes (${percentage}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-[#00bcd4] h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <button class="vote-poll-btn ${hasVoted ? 'voted' : 'btn-primary'} text-white font-bold py-2.5 px-3 rounded-md text-xs mt-2 ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            data-post-id="${postId}" data-option-index="${index}" ${hasVoted ? 'disabled' : ''}>
                                            ${hasVoted ? 'Voted' : 'Vote'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${totalVotes > 0 ? `<p class="text-right text-xs text-gray-500 mt-4">Total Votes: ${formatNumberForDisplay(totalVotes)}</p>` : `<p class="text-center text-gray-400 text-sm mt-4">No votes yet. Be the first to vote!</p>`}
                    </div>
                `;
            }

			modalContent.innerHTML = `
				<div class="flex justify-between items-center mb-4">
					<button id="close-modal-btn" class="modal-action-btn"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex gap-2">
                        <button id="share-post-btn" class="modal-action-btn" data-post-id="${postId}"><i class="fa-solid fa-share"></i></button>
                        <button id="fullscreen-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
                    </div>
				</div>
				<h2 class="text-2xl sm:text-3xl font-bold mb-4 text-white">${post.title}</h2>
				${mediaHtml}
				${modalYoutubeLinkHtml} <!-- Add the combo link button here -->
				<div class="mt-6 flex flex-wrap gap-2 text-gray-400 text-sm">
					<span><strong>Posted:</strong> ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
					${post.postType === 'Game Promotion' ? `<span><strong>Pricing:</strong> ${post.pricing}</span>` : ''}
					<span><strong>Type:</strong> ${post.postType}</span>
					${post.postType === 'Devlog' && post.devlogType ? `<span><strong>Devlog Type:</strong> ${post.devlogType}</span>` : ''}
					${post.madeWith ? `<span><strong>Made With:</strong> ${post.madeWith}</span>` : ''}
					<span><strong>AI Content:</strong> ${post.aiContent}</span>
					<span><strong>Views:</strong> ${formatNumberForDisplay(post.views || 0)}</span>
					${post.postType === 'Game Promotion' ? `
						<span><strong>Visits:</strong> ${formatNumberForDisplay(post.visits || 0)}</span>
					` : ''}
                </div>
                <div class="markdown-content text-gray-300 my-4 text-justify text-sm sm:text-base">${convertMarkdownToHtml(post.description)}</div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    ${post.postType === 'Game Promotion' && post.genres && post.genres.length > 0 ? post.genres.map(g => `<span class="bg-blue-700 text-white text-xs font-semibold px-2 py-1 rounded-full">${g}</span>`).join('') : ''}
                    ${post.postType === 'Game Promotion' && post.platforms && post.platforms.length > 0 ? post.platforms.map(p => `<span class="bg-green-700 text-white text-xs font-semibold px-2 py-1 rounded-full">${p}</span>`).join('') : ''}
                    ${post.tags && post.tags.length > 0 ? post.tags.map(t => `<span class="bg-purple-700 text-white text-xs font-semibold px-2 py-1 rounded-full">${t}</span>`).join('') : ''}
                </div>

                <div class="flex justify-center my-6 gap-4">
                    <a href="${post.itchLink}" target="_blank" id="visit-itch-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base">
                        <i class="fas fa-external-link-alt"></i> Visit Itch.io
                    </a>
                    ${post.postType === 'Devlog' && post.linkedGamePromoId ? `
                        <button id="view-linked-game-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base" data-linked-post-id="${post.linkedGamePromoId}">
                            <i class="fas fa-gamepad"></i> View Linked Game
                        </button>
                    ` : ''}
                </div>

                ${post.general ? `<div class="mt-4"><h3 class="font-semibold text-lg text-gray-200">General Info:</h3><p class="text-gray-300 text-sm sm:text-base">${post.general}</p></div>` : ''}
                ${post.reason ? `<div class="mt-4"><h3 class="font-semibold text-lg text-gray-200">Why I'm Posting:</h3><p class="text-gray-300 text-sm sm:text-base">${post.reason}</p></div>` : ''}

                ${pollHtml} <!-- Add poll HTML here -->

                ${post.allowComments !== false ? ` <!-- Conditional rendering for comments section -->
                    <div class="mt-8 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-300">Comments (${formatNumberForDisplay(post.comments?.length || 0)})</h3>
                        <div id="comments-list" class="space-y-4 mb-6">
                            ${post.comments && post.comments.length > 0 ? post.comments.map((comment, index) => `
                                <div class="bg-[#1a1a1a] p-4 rounded-md shadow-sm">
                                    <p class="text-gray-300 text-sm sm:text-base">${comment.text}</p>
                                    <div class="flex justify-end items-center mt-2">
                                        ${post.authorId === currentUser?.uid ? `
                                            <button class="delete-comment-btn text-red-500 hover:text-red-400 transition ml-0" data-post-id="${postId}" data-comment-index="${index}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                        <p class="text-right text-xs text-gray-500 ml-auto">Comment by Anonymous on ${new Date(comment.timestamp.toDate()).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-400 text-sm sm:text-base">No comments yet. Be the first to leave feedback!</p>'}
                        </div>
                        <form id="comment-form" class="flex gap-2">
                            <input type="text" id="comment-input" class="flex-grow p-3 input-bg rounded-md text-sm sm:text-base" placeholder="Add a comment..." required>
                            <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-md text-sm sm:text-base">Post</button>
                        </form>
                    </div>
                ` : `<div class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-400">Comments are disabled for this post.</div>`}
            `;
            postModal.classList.remove('hidden'); // Show the modal
            updateBodyScrollLock(); // Ensure body scroll is locked
            updateDocumentTitle(`${post.title} on PostItch`); // Update document title for post modal

            // If opened from URL and it's a YouTube media type, initialize player on play button click
            if (fromURL && post.mediaType === 'youtube' && post.trailerLink) {
                const modalYoutubePlayButton = document.getElementById('modal-youtube-play-button');
                if (modalYoutubePlayButton) {
                    modalYoutubePlayButton.addEventListener('click', () => {
                        const videoId = modalYoutubePlayButton.dataset.videoId;
                        const playerContainer = modalYoutubePlayButton.parentElement; // The div containing img and play button
                        playerContainer.innerHTML = `<div id="modal-youtube-player"></div>`; // Replace with player div

                        youtubePlayer = new YT.Player('modal-youtube-player', {
                            videoId: videoId,
                            playerVars: {
                                autoplay: 1,
                                controls: 1,
                                modestbranding: 1,
                                rel: 0,
                                showinfo: 0,
                                iv_load_policy: 3,
                                mute: userSettings.alwaysMuteVideos ? 1 : 0 // Apply mute setting
                            },
                            events: {
                                'onReady': (event) => {
                                    event.target.playVideo();
                                }
                            }
                        });
                    });
                }
            }
            
            // Apply fullscreen if setting is enabled
            if (userSettings.modalFullscreen) {
                toggleFullscreen(modalContent, true); // Pass true to force fullscreen on open
            }
            document.getElementById('close-modal-btn').addEventListener('click', closePostModal);
            document.getElementById('fullscreen-toggle-btn').addEventListener('click', () => toggleFullscreen(modalContent)); // Add listener for fullscreen toggle
            
            // Add event listener for "Visit Itch.io" button to increment visits
            const visitItchBtn = document.getElementById('visit-itch-btn');
            if (visitItchBtn) {
                visitItchBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Crucial: Prevent click from bubbling to modal backdrop
                    // Only increment if it's a Game Promotion post
                    if (post.postType === 'Game Promotion') {
                        try {
                            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                            await updateDoc(postRef, { visits: (post.visits || 0) + 1 });
                            // Optimistically update the local data
                            post.visits = (post.visits || 0) + 1;
                        } catch (error) {
                            console.error("Error incrementing visit count:", error);
                        }
                    }
                });
            }

            // Add event listener for "View Linked Game" button
            const viewLinkedGameBtn = document.getElementById('view-linked-game-btn');
            if (viewLinkedGameBtn && post.linkedGamePromoId) {
                viewLinkedGameBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Crucial: Prevent click from bubbling to modal backdrop
                    // Close the current modal before opening the new one
                    closePostModal(); 
                    await openPostModal(e.currentTarget.dataset.linkedPostId, false, true); // When opening a linked game, it's a new user-initiated view
                });
            }

            // Add event listener for the new custom YouTube link button
            const openVideoPlayerBtn = document.getElementById('open-video-player-btn');
            if (openVideoPlayerBtn) {
                openVideoPlayerBtn.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    e.stopPropagation(); // Prevent click from bubbling to modal backdrop
                    const videoId = e.currentTarget.dataset.videoId;
                    if (videoId) {
                        openVideoModal(videoId, post.title); // Pass post title to video modal
                    } else {
                        showAlert("Video ID not found for playback.");
                    }
                });
            }

            // Add event listener for share button
            document.getElementById('share-post-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent modal from closing if share button is clicked
                const shareLink = `https://postitchindie.github.io/?postId=${postId}`;
                copyToClipboard(shareLink);
                showAlert("Link copied to clipboard!");
            });


            if (post.allowComments !== false) { // Only add comment form listener if comments are allowed
                document.getElementById('comment-form').addEventListener('submit', (e) => handleCommentSubmit(e, postId));
                // Removed event listeners for comment likes
                // Add event listeners for comment delete buttons
                document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.removeEventListener('click', (e) => { /* remove old listener */ }); // Remove existing listeners to prevent duplicates
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const commentIndex = parseInt(btn.dataset.commentIndex);
                        deleteComment(postId, commentIndex);
                    });
                });
                if (focusComment) {
                    document.getElementById('comment-input').focus(); // Optionally focus the comment input
                }
            }

            // Add event listeners for poll voting
            if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || (post.postType === 'Game Promotion' && post.poll)) {
                document.querySelectorAll('.vote-poll-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const optionIndex = parseInt(btn.dataset.optionIndex); // Corrected property name
                        voteOnPoll(postId, optionIndex);
                    });
                });
            }
        }

        // Closes the post detail modal.
        function closePostModal() {
            postModal.classList.add('hidden');
            modalContent.innerHTML = ''; // Clear content to prevent old data from flashing on next open
            editingPostId = null; // Reset editing state
            isPostModalOpen = false; // Reset flag when modal is closed
            // Ensure fullscreen mode is off when closing the modal
            toggleFullscreen(modalContent, false); // Force fullscreen off on close
            updateBodyScrollLock(); // Update body scroll lock after closing
            updateDocumentTitle(document.querySelector('.nav-item.active')?.textContent || 'Community'); // Reset title to current tab

            // Remove postId from URL when modal is closed
            const url = new URL(window.location.href);
            url.searchParams.delete('postId');
            window.history.replaceState({}, document.title, url.toString());
        }

        // Handles the submission of a new comment for a post.
        async function handleCommentSubmit(e, postId) {
            e.preventDefault();
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before commenting.");
                return;
            }
            // Fetch the current state of the post to check allowComments
            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post || post.allowComments === false) {
                showAlert("Comments are disabled for this post.");
                return;
            }

            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                showAlert("Comment cannot be empty.");
                return;
            }

            // Get the document reference using the correct Firestore path
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            
            // Create a new comments array with the new comment appended
            const newComments = [...(post.comments || []), {
                authorId: currentUser.uid, // Store the anonymous user's UID
                text: commentText,
                timestamp: new Date(), // Use client-side Date object for timestamp in array
                // Removed likes: [] for new comment
            }];

            try {
                await updateDoc(postRef, { comments: newComments });
                commentInput.value = ''; // Clear input field
                // The onSnapshot listener will re-render the modal with updated comments.
                // No need for optimistic update here as onSnapshot is fast enough.
            } catch (error) {
                console.error("Error adding comment: ", error);
                showAlert(`Failed to post comment: ${error.message || error}.`);
            }
        }

        // Removed function: toggleCommentLike

        // Deletes a specific comment from a post.
        async function deleteComment(postId, commentIndex) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete.");
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId);

            if (!post || !post.comments || commentIndex < 0 || commentIndex >= post.comments.length) {
                console.error("Comment not found for deletion:", postId, commentIndex);
                showAlert("Could not delete comment: Comment not found.");
                return;
            }

            // Only allow post owner to delete comments
            if (post.authorId !== currentUser.uid) {
                showAlert("You can only delete comments on your own posts.");
                return;
            }

            const confirmed = await showConfirm("Are you sure you want to delete this comment? This cannot be undone.");
            if (!confirmed) {
                return;
            }

            // Create a new comments array without the comment to be deleted
            const updatedComments = post.comments.filter((_, idx) => idx !== commentIndex);

            try {
                await updateDoc(postRef, { comments: updatedComments });
                showAlert("Comment deleted successfully.");
                // The onSnapshot listener will re-render the modal with updated comments.
            } catch (error) {
                console.error("Error deleting comment:", error);
                showAlert(`Failed to delete comment: ${error.message || error}.`);
            }
        }

        // Handles voting on a poll within a Devlog or Game Promotion.
        async function voteOnPoll(postId, optionIndex) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before voting.");
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId);

            if (!post || !post.poll || optionIndex < 0 || optionIndex >= post.poll.options.length) {
                console.error("Poll or option not found for voting:", postId, optionIndex);
                showAlert("Could not cast vote: Poll or option not found.");
                return;
            }

            let currentPoll = post.poll;
            let newVoters = currentPoll.voters || [];

            if (newVoters.includes(currentUser.uid)) {
                showAlert("You have already voted on this poll.");
                return;
            }

            // Deep copy poll options to modify votes
            const updatedOptions = JSON.parse(JSON.stringify(currentPoll.options));
            updatedOptions[optionIndex].votes = (updatedOptions[optionIndex].votes || 0) + 1;
            newVoters.push(currentUser.uid); // Add current user to voters list

            try {
                await updateDoc(postRef, {
                    'poll.options': updatedOptions,
                    'poll.voters': newVoters
                });
                // The onSnapshot listener will re-render the modal with updated poll results
            } catch (error) {
                console.error("Error voting on poll:", error);
                showAlert(`Failed to cast vote: ${error.message || error}.`);
            }
        }


        // Function to copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }

    </script>
</body>
</html>
